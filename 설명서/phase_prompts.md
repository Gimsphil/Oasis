# 오아시스(OASIS) - 단계별 구현 세부 프롬프트

> 각 프롬프트는 독립적으로 실행 가능하며, 앞 단계 완료 후 순서대로 진행합니다.
> 각 프롬프트 시작 시 관련 파일을 먼저 스캔한 후 작업하도록 지시합니다.

---

## ══════════════════════════════════════════════
## PHASE 1: 핵심 산출 기능 강화
## ══════════════════════════════════════════════

---

### PROMPT 1-1: 산출수식 문자 포함 안전 파서 구현

```
D:\오아시스\SANCHUL_Sheet_1 프로젝트에서 작업합니다.

[목표]
산출수식(FORMULA 컬럼)에 문자가 포함되어도 안전하게 숫자만 추출하여 계산하는 파서를 구현합니다.

[현재 상태]
- output_detail_tab.py의 on_eulji_cell_changed() 메서드 (약 라인 996~1029)
- 현재 eval() 기반으로 수식을 계산하며, regex로 숫자/연산자만 필터링
- 필터 패턴: r"[^\d\+\-\*\/\.\(\)]"
- 문제: "2.3 + ↗ 2.3 + 귀로(2.9-1.8)" 같은 수식에서 한글/특수문자가 있으면 오류 발생 가능

[요구 사항]
1. utils/ 폴더에 formula_parser.py 신규 파일 생성
2. parse_formula(text: str) -> float 함수 구현:
   - 입력: "2.3+↗2.3+귀로(2.9-1.8)" → 출력: 5.7
   - 입력: "3.5*2+2.3+<2.1+6.3+1.2>+4.2" → 출력: 20.1 (< > 안의 내용도 정상 계산)
   - 입력: "1+5+7+2.5+14+40" → 출력: 69.5
   - 입력: "(4.2+8.7+2.4)*2" → 출력: 30.6
   - 입력: "" 또는 None → 출력: 0.0
   - 입력: "순수문자만" → 출력: 0.0
3. 구현 방식:
   - < > 꺽쇠 괄호를 일반 괄호 ( )로 치환
   - 한글, 특수문자(↗, ㎜ 등), 영문자를 제거하되, 소수점/연산자/괄호/숫자는 보존
   - 연속된 연산자 정리 (예: "+-" → "-", "++" → "+")
   - 빈 괄호 "()" 제거
   - 수식 앞뒤의 불필요한 연산자 정리
   - 최종적으로 eval() 또는 ast.literal_eval 등으로 안전 계산
4. output_detail_tab.py의 on_eulji_cell_changed()에서 기존 regex+eval 부분을 parse_formula() 호출로 교체
5. calculation_unit_price_popup.py의 _evaluate_math() 메서드도 동일한 parse_formula()를 사용하도록 교체

[테스트]
- 각 케이스별 assert 테스트 코드를 formula_parser.py 하단에 if __name__ == "__main__": 블록으로 작성
- 실행: python D:\오아시스\SANCHUL_Sheet_1\utils\formula_parser.py

[주의]
- 기존 정상 동작하는 순수 숫자 수식(3.5+2.1*4)은 반드시 정상 작동해야 함
- eval() 사용 시 __builtins__ 제한하여 보안 유지
- 파싱 실패 시 0.0 반환 (에러 raise 하지 않음)
```

---

### PROMPT 1-2: 산출수식 Enter 연속입력 (자동 줄 추가/합산)

```
D:\오아시스\SANCHUL_Sheet_1 프로젝트에서 작업합니다.

[배경]
이지테크 매뉴얼(p155-157, p206)에 따르면:
- 산출수식 셀에서 숫자 입력 후 Enter 키를 누르면 기존 수식 뒤에 "+"를 붙여 연속 입력
- 산출수식 셀은 40byte 제한이 있음
- 40byte 초과 시 자동으로 다음 줄(같은 산출목록)에 이어서 수식을 추가
- 여러 줄에 걸친 수식은 합산하여 계(TOTAL)에 반영

[현재 상태]
- managers/event_filter.py에서 키보드 이벤트 처리
- output_detail_tab.py의 on_eulji_cell_changed()에서 FORMULA 컬럼 계산
- EULJI_COLS: NUM=0, GUBUN=1, FROM=2, TO=3, CIRCUIT=4, ITEM=5, FORMULA=6, TOTAL=7, UNIT=8, REMARK=9

[요구 사항]
1. managers/event_filter.py에 산출수식 Enter 연속입력 로직 추가:
   - 을지 테이블의 FORMULA 컬럼(6)에서 Enter 키 감지
   - 현재 셀에 이미 수식이 있는 경우:
     a. 새로 입력된 값을 기존 값 뒤에 "+"로 연결 (예: "3.5" → "3.5+2.1")
     b. 결합된 문자열의 byte 수 계산 (한글=2byte, 영문/숫자=1byte)
     c. 40byte 이내: 같은 셀에 업데이트
     d. 40byte 초과: 다음 행의 같은 산출목록으로 자동 이동하여 입력
        - 다음 행의 산출목록(ITEM)이 비어있거나 같은 값이면 해당 행 사용
        - 아니면 새 행을 삽입하고 산출목록을 복사
   - Enter 후 커서는 다시 FORMULA 컬럼에 대기 (연속 입력 가능)

2. output_detail_tab.py의 on_eulji_cell_changed() 수정:
   - 같은 산출목록의 연속 행들의 FORMULA를 모두 합산하여 첫 행의 TOTAL에 반영
   - 이어진 행들의 TOTAL은 비우거나 부분합 표시
   - 연속 행 판단: 같은 ITEM 값 + 연속된 행번호

3. 40byte 계산 유틸리티 함수:
   - utils/formula_parser.py에 calc_byte_length(text: str) -> int 추가
   - 한글/특수문자=2byte, 영문/숫자/연산자=1byte

[테스트 시나리오]
- "3.5" 입력 후 Enter → "3.5+" 표시, 커서 대기
- "2.1" 입력 후 Enter → "3.5+2.1+" 표시
- 40byte 초과 시 → 다음 행에 자동 이어짐
- 합산: 첫 행 TOTAL = 모든 연속 행의 수식 합산값

[주의]
- 기존 Enter 키의 산출일위표 포커스 이동 기능(ITEM 컬럼에서)과 충돌하지 않도록 주의
- FORMULA 컬럼에서만 연속입력, ITEM 컬럼에서는 기존 동작 유지
- blockSignals 사용하여 무한루프 방지
```

---

### PROMPT 1-3: Ctrl+C/Ctrl+V 셀 복사/붙이기

```
D:\오아시스\SANCHUL_Sheet_1 프로젝트에서 작업합니다.

[배경]
매뉴얼(p206-208, p214-215)에 따르면:
- Ctrl+C/Ctrl+V로 셀 및 행 복사/붙이기
- 번호(NUM) 열에서 복사하면 행 전체 복사
- 다른 열에서 복사하면 해당 열의 셀만 복사
- 다중 선택(Shift+↓)으로 여러 셀/행 범위 복사 가능
- Ctrl+X로 잘라내기 가능

[현재 상태]
- managers/event_filter.py에 Ctrl+C/V/X 처리 없음
- F5/F6/F7은 calculation_unit_price_popup.py에서 구현됨 (산출일위표 전용)

[요구 사항]
1. managers/event_filter.py에 Ctrl+C, Ctrl+V, Ctrl+X 핸들러 추가:

   - **Ctrl+C (복사):**
     a. 현재 선택된 셀/범위 감지
     b. NUM 열(0)에 커서가 있으면 → 전체 행 데이터 복사 (모든 열 + 일위대가 chunk 데이터 포함)
     c. 다른 열에 커서가 있으면 → 해당 열의 선택 범위만 복사
     d. 내부 클립보드(self.parent_tab._clipboard)에 저장
     e. 동시에 시스템 클립보드에도 텍스트로 복사 (엑셀 호환: 탭 구분)

   - **Ctrl+V (붙이기):**
     a. 내부 클립보드 데이터가 있으면 내부 데이터 사용
     b. 없으면 시스템 클립보드에서 텍스트 파싱 (탭 구분 → 셀 분배)
     c. 행 복사 데이터인 경우: 현재 커서 위치에 새 행 삽입 후 붙이기
     d. 셀 복사 데이터인 경우: 현재 셀부터 순서대로 붙이기
     e. 일위대가 chunk 데이터가 포함된 경우 chunk도 함께 복사

   - **Ctrl+X (잘라내기):**
     a. Ctrl+C와 동일하게 복사 후
     b. 원본 셀/행 내용 삭제
     c. 행 잘라내기의 경우 행 자체는 유지하고 내용만 삭제

2. output_detail_tab.py에 클립보드 관련 속성 추가:
   - self._clipboard = {"type": "cell"|"row", "data": [...], "chunks": {...}}

3. 실행취소(Ctrl+Z) 지원:
   - 붙이기/잘라내기 작업을 undo 스택에 기록

[주의]
- blockSignals로 붙이기 중 이벤트 폭주 방지
- 을지와 갑지 양쪽 테이블에서 모두 동작
- 산출일위표(popup) 내에서는 기존 F5/F6 동작 유지 (충돌 방지)
```

---

### PROMPT 1-4: F4 수량 없이 입력 (1@ 표시)

```
D:\오아시스\SANCHUL_Sheet_1 프로젝트에서 작업합니다.

[배경]
매뉴얼(p181)에 따르면:
- 산출수식에 수량을 넣지 않고 자료만 입력할 때 F4 키 사용
- F4 입력 시 산출수식에 "1@"이 자동 입력됨
- 이는 간선산출판 등에서 자료사전의 자료를 추가할 때 수량 없이 입력하는 용도

[현재 상태]
- managers/event_filter.py에서 F4 키 미처리
- 산출수식 계산 시 "1@"이 있으면 eval 에러 발생할 수 있음

[요구 사항]
1. managers/event_filter.py에 F4 핸들러 추가:
   - 을지 테이블에서 F4 키 감지
   - 현재 행의 산출수식(FORMULA, col 6)에 "1@" 입력
   - 계(TOTAL, col 7)에 0 또는 빈 값 설정 (수량 없음이므로)
   - 커서를 다음 행으로 이동

2. utils/formula_parser.py의 parse_formula() 수정:
   - "1@" 패턴을 만나면 0.0으로 처리 (수량 없는 자료)
   - "@"가 포함된 수식은 수량 계산에서 제외

3. output_detail_tab.py의 on_eulji_cell_changed() 수정:
   - "1@" 수식은 TOTAL을 0으로 설정하되, 자료로는 유효하게 처리
   - 소요자재 집계 시 "1@" 항목도 포함되도록 (수량 0이지만 존재)

[주의]
- F4는 을지 테이블에서만 동작 (갑지, 산출일위표에서는 미동작)
- "1@" 표기는 인쇄 시에도 그대로 표시
```

---

## ══════════════════════════════════════════════
## PHASE 2: 산출 효율화 기능
## ══════════════════════════════════════════════

---

### PROMPT 2-1: $H/$L 변수 대입 시스템

```
D:\오아시스\SANCHUL_Sheet_1 프로젝트에서 작업합니다.

[배경]
매뉴얼(p147-148, p250-251)에 따르면:
- 총괄표(갑지)에 $H(층고), $L(천정내 높이) 컬럼이 있음
- 기본값: $H=3(m), $L=1.5(m)
- 산출수식이나 일위대가 단위수량에 "$H", "$L" 문자가 있으면 실제 값으로 치환하여 계산
- 예: "$Hm-1.8m" → "3.5m-1.8m" → 1.7 (층고가 3.5일 때)
- 예: 일위대가 단위수량 "$L*2" → "1.5*2" → 3.0

[현재 상태]
- 갑지 테이블에 층고($H, col 5), 천정(col 6) 컬럼 존재
- 변수 치환 로직 없음

[요구 사항]
1. utils/formula_parser.py에 변수 치환 함수 추가:
   - substitute_variables(formula: str, variables: dict) -> str
   - variables = {"$H": "3.5", "$L": "1.5", "$A": "", "$B": ""}
   - "$H" → "3.5", "$L" → "1.5" 치환
   - "$Hm" → "3.5" (뒤의 'm' 단위 문자 제거)
   - 빈 변수는 기본값 사용 ($H=3, $L=1.5)

2. output_detail_tab.py 수정:
   - _load_eulji_data() 시 현재 공종의 갑지 행에서 $H, $L 값 추출
   - self._current_variables = {"$H": "3.5", "$L": "1.5"} 저장
   - on_eulji_cell_changed()에서 parse_formula() 호출 전 substitute_variables() 적용

3. calculation_unit_price_popup.py 수정:
   - _update_row_total()에서 단위수량 계산 시 변수 치환 적용
   - parent_tab._current_variables를 참조

[테스트]
- 갑지에서 층고 3.5, 천정 1.5 입력
- 을지 산출수식에 "$Hm-1.8m" 입력 → 계 = 1.7
- 일위대가 단위수량에 "$L*2" 입력 → 단위계 = 3.0
- 층고 비어있으면 기본값 3 적용
```

---

### PROMPT 2-2: 수작업 자재 입력 (명칭;규격;단위 세미콜론 구분)

```
D:\오아시스\SANCHUL_Sheet_1 프로젝트에서 작업합니다.

[배경]
매뉴얼(p182-183, p238)에 따르면:
- 자료사전에 없는 자재는 산출목록에 "명칭;규격;단위" 형식으로 직접 입력
- 예: "분전반;P-1;식" → 추후 견적 변환 시 품명="분전반", 규격="P-1", 단위="식"으로 분리
- 산출일위대가에서도 "명칭+규격+단위" 또는 "명칭;규격;단위" 형식 사용
- "+" 구분자도 ";" 과 동일하게 동작

[현재 상태]
- 산출목록(ITEM, col 5)에 자유 텍스트 입력 가능
- 세미콜론 파싱 로직 없음
- 산출내역서에서 자료사전 DB가 없는 자재 처리 미구현

[요구 사항]
1. output_detail_tab.py의 on_eulji_cell_changed() 수정:
   - ITEM 컬럼(5) 변경 시 세미콜론 감지
   - "분전반;P-1;식" 입력 시:
     a. 산출목록(ITEM)에는 "분전반;P-1;식" 그대로 표시
     b. 내부 데이터로 {name: "분전반", spec: "P-1", unit: "식"} 파싱 저장
     c. 해당 행을 수작업 자재(-*)로 마킹
   - 세미콜론이 없으면 기존 동작 유지

2. utils/formula_parser.py에 유틸 함수 추가:
   - parse_manual_item(text: str) -> dict
   - 입력: "분전반;P-1;식" → {"name": "분전반", "spec": "P-1", "unit": "식"}
   - 입력: "분전반+P-1+식" → 동일 결과 ("+"도 구분자로 인식)
   - 입력: "일반텍스트" → {"name": "일반텍스트", "spec": "", "unit": ""}

3. 산출일위대가에서도 동일 적용:
   - calculation_unit_price_popup.py의 LIST 컬럼 입력 시
   - 세미콜론/플러스 구분자로 수작업 자재 입력 지원

[주의]
- 기존 자료사전에서 불러온 데이터는 영향 없음
- "+"는 수식의 덧셈 연산자와 구분 필요: ITEM 컬럼에서만 구분자로 인식
```

---

### PROMPT 2-3: 구간접속 자동 산출

```
D:\오아시스\SANCHUL_Sheet_1 프로젝트에서 작업합니다.

[배경]
매뉴얼(p336-340)에 따르면:
- 구간접속은 산출수식을 분석하여 "+"로 구분된 수치의 수를 구간으로 계산
- 예: "2.3+3.2+5+2.3" → 4구간
- 예: "2.3*3+1.2+2+4" → 6구간 (*3은 3구간으로 계산)
- 예: "2.3+<1.5+2.3>+3" → 3구간 (<>로 묶인 부분은 1구간)
- 구간접속 = 양 끝 박스 내 전선접속, 접속선 길이 = 0.2m*2*구간수
- Ctrl+1~9: 현재 줄 위로 N줄의 구간을 합산하여 접속선 산출

[현재 상태]
- 구간접속 관련 로직 없음
- 산출수식 파서(formula_parser.py)는 Phase 1에서 구현 예정

[요구 사항]
1. utils/formula_parser.py에 구간 계산 함수 추가:
   - count_sections(formula: str) -> int
   - "+"로 분리된 각 토큰의 구간 수 합산
   - "*N" 패턴이 있으면 N구간으로 계산 (예: "2.3*3" → 3구간)
   - < > 꺽쇠 안의 내용은 통째로 1구간
   - 빈 수식 → 0구간

2. core/ 폴더에 section_connection.py 신규 파일 생성:
   - calculate_connection(formula: str, wire_length: float = 0.2, connection_count: int = 2) -> dict
   - 반환: {"sections": 4, "total_length": 1.6, "formula": "0.2*2*4"}
   - 접속선 길이 = wire_length * connection_count * sections

3. managers/event_filter.py에 Ctrl+1~9 핸들러 추가:
   - 을지 테이블에서 Ctrl+숫자(1~9) 감지
   - 현재 커서 위치에서 위로 N줄의 산출수식 구간을 합산
   - 현재 행에 접속선 산출 결과 자동 입력
   - 산출목록: "(접속선)" 등의 표시
   - 산출수식: "0.2*2*{구간수}"
   - 계: 계산 결과

4. 산출일위표 단축키 메뉴에 "접속선" 버튼 추가 (선택적):
   - calculation_unit_price_popup.py 하단 메뉴에 버튼 추가
   - 클릭 시 현재 을지 행의 수식 기반으로 구간접속 자동 생성

[테스트]
- "2.3+3.2+5+2.3" → 4구간, 접속선 = 0.2*2*4 = 1.6
- "2.3*3+1.2+2+4" → 6구간
- "2.3+<1.5+2.3>+3" → 3구간
- Ctrl+3 (위로 3줄 합산): 3줄의 구간수 총합
```

---

### PROMPT 2-4: 000. 기초작업 템플릿 시스템

```
D:\오아시스\SANCHUL_Sheet_1 프로젝트에서 작업합니다.

[배경]
매뉴얼(p143-144, p219-222, p229-234)에 따르면:
- 새 파일 생성 시 "000. 기초작업" 공종이 자동 생성됨
- 조명기구(4각/8각 BOX), 분전반(수작업/일위대가) 등의 프리셋 데이터 포함
- 조명기구 일위대가에 최대 11개 세부아이템 (기구, 등보강, 박스, 커버, 가요관, 콘, 전선 등)
- 단위에 "@" → 산출목록명 변경 시 일위대가 첫 줄도 연동
- 단위에 "#" → "@" 기능 + 일위대가 속성

[현재 상태]
- 갑지에서 공종 생성 가능
- 기초작업 자동 생성 없음
- 템플릿 데이터 없음

[요구 사항]
1. data/ 폴더에 templates/ 하위 폴더 생성
2. data/templates/basic_work.json 생성:
   - 000. 기초작업의 을지 데이터 (조명기구 A~D Type, 분전반 등)
   - 각 조명기구별 산출일위대가 데이터 (기구, 등보강, 박스, 커버, 가요관, 콘, 전선 등)
   - 매뉴얼 p220-221의 구조를 JSON으로 재현

3. output_detail_tab.py에 기초작업 자동 생성 로직:
   - 새 프로젝트(파일) 생성 시 첫 번째 공종으로 "000. 기초작업(조명기구, 분전반)" 자동 추가
   - basic_work.json 템플릿 데이터를 을지에 자동 로드
   - 관련 산출일위대가 chunk 파일도 함께 생성

4. "@" 기호 연동 로직:
   - 을지 산출목록 변경 시, 단위가 "@" 또는 "#"이면 일위대가 첫 줄도 동일하게 변경
   - on_eulji_cell_changed()에서 ITEM 컬럼 변경 감지 → 일위대가 chunk 업데이트

[데이터 구조 예시]
{
  "조명기구 (4각BOX) TYPE-A": {
    "unit_items": [
      {"name": "조명기구", "qty": "1"},
      {"name": "등보강(M-bar)", "qty": "1"},
      {"name": "4각 아울렛박스", "qty": "1"},
      {"name": "4각 박스커버", "qty": "1"},
      {"name": "가요전선관 16c", "qty": "1.5"},
      {"name": "가요콘 16c", "qty": "2"},
      {"name": "HIV 2.5sq", "qty": "0.2*2+$L*2+0.2*2"}
    ]
  }
}
```

---

## ══════════════════════════════════════════════
## PHASE 3: 집계/관리 기능
## ══════════════════════════════════════════════

---

### PROMPT 3-1: 소요자재 집계 기능

```
D:\오아시스\SANCHUL_Sheet_1 프로젝트에서 작업합니다.

[배경]
매뉴얼(p191-192, p341-342)에 따르면:
- 산출 총괄표에서 "소요자재" 버튼 클릭 → 전체 파일에 사용된 자재 목록 집계
- 각 자재별: 품명, 규격, 단위, 수량합계, 단가, 품셈 정보
- 새로고침: 재집계, ReMast: 자료사전 DB 정보로 업데이트
- 근거추적: 특정 자재가 어느 공종에서 산출되었는지 추적
- Txt 파일: 엑셀 호환 텍스트 변환

[현재 상태]
- 소요자재 관련 기능 없음
- 을지 데이터는 공종별로 메모리 캐시에 저장 (self.eulji_data)

[요구 사항]
1. popups/ 폴더에 material_summary_popup.py 신규 파일 생성:
   - MaterialSummaryPopup(QDialog) 클래스
   - 전체 공종의 을지 데이터를 순회하며 산출목록별 수량 합산
   - 동일 자재(CODE 또는 산출목록명 기준) 합산
   - 테이블 표시: 번호, 품명, 규격, 단위, 산출수량, 결정수량, 단가, 금액

2. 기능 버튼:
   - 새로고침: 전체 데이터 재집계
   - 근거추적: 선택된 자재의 사용 공종/행번호 목록 표시 (서브 다이얼로그)
   - Txt파일: 클립보드에 탭 구분 텍스트 복사 (엑셀 붙이기 호환)
   - 닫기: 팝업 종료

3. output_detail_tab.py 상단 메뉴 "도구(T)" 버튼에 연결:
   - "도구" 클릭 시 드롭다운 메뉴 표시
   - "소요자재" 항목 → MaterialSummaryPopup 열기

4. 집계 알고리즘:
   - self.eulji_data의 모든 공종을 순회
   - 각 행의 산출목록 + 일위대가 세부아이템을 분해
   - 동일 자재는 수량 합산
   - 자료사전 DB와 매칭하여 품명/규격/단위 보완

[주의]
- 대량 데이터(수천 행) 처리 시 성능 고려
- 을지 데이터가 메모리에 없는 공종은 파일에서 로드
```

---

### PROMPT 3-2: 전체 목록 집계 및 일괄 변경 도구

```
D:\오아시스\SANCHUL_Sheet_1 프로젝트에서 작업합니다.

[배경]
매뉴얼(p344-348)에 따르면:
- 도구 > 전체 목록 집계하기: 모든 공종의 산출목록을 하나로 취합
- 집계된 목록에서 산출일위대가 내용을 수정하면 → 전체 공종에 반영 가능
- 도구 > 산출 보조 내용 일괄 바꾸기: 수정된 일위대가를 각 공종에 적용
- 도구 > 을지 일부자료 산출수량 증감: 특정 자재의 수량을 비율(%)로 증감
- 도구 > 자료를 다른 재질로 바꾸기: HI→ST 등 재질 일괄 변경

[현재 상태]
- 위 기능 모두 미구현
- 도구 메뉴 버튼 존재하지만 기능 미연결

[요구 사항]
1. core/ 폴더에 batch_tools.py 신규 파일 생성:
   - aggregate_all_items(eulji_data: dict) -> list: 전체 목록 집계
   - batch_replace_unit_price(eulji_data: dict, old_item: str, new_unit_prices: list): 일위대가 일괄 교체
   - batch_adjust_quantity(eulji_data: dict, target_items: list, percentage: float): 수량 증감
   - batch_change_material(eulji_data: dict, before: dict, after: dict): 재질 변경

2. popups/ 폴더에 batch_tools_popup.py 신규 파일 생성:
   - BatchToolsPopup(QDialog): 일괄 변경 도구 UI
   - 탭 구조: 목록집계 | 수량증감 | 재질변경
   - 각 탭에 입력 필드, 미리보기, 실행 버튼

3. output_detail_tab.py 도구 메뉴 연결:
   - "도구(T)" 버튼 클릭 시 컨텍스트 메뉴 표시
   - 메뉴 항목: 전체 목록 집계, 산출 보조 내용 일괄 바꾸기, 수량 증감, 재질 변경, 소요자재
   - 각 항목 클릭 시 해당 팝업 실행

[주의]
- 일괄 변경은 되돌리기가 어려우므로 실행 전 확인 다이얼로그 표시
- 변경 전 데이터 백업 권장 알림
- 을지 데이터 캐시와 파일 양쪽 모두 업데이트
```

---

## ══════════════════════════════════════════════
## PHASE 4: 출력/변환 기능
## ══════════════════════════════════════════════

---

### PROMPT 4-1: 산출 → 견적 변환 (내역작성)

```
D:\오아시스\SANCHUL_Sheet_1 프로젝트에서 작업합니다.

[배경]
매뉴얼(p192-195)에 따르면:
- 산출작업 완료 후 "내역작성" 버튼으로 견적 내역서 변환
- 옵션: 재료할증, 수량 소수 조정, 1:1 층별 작성, 기존 단가 재사용
- 변환 결과: 견적 총괄표에 공종별 자재 목록 생성
- 일위대가 속성 자재는 견적 총괄표에 자동 등록

[현재 상태]
- 산출 데이터는 존재하지만 견적 변환 로직 없음
- 견적 파일 형식 미정의

[요구 사항]
1. core/ 폴더에 estimate_converter.py 신규 파일 생성:
   - convert_to_estimate(project_data: dict, options: dict) -> dict
   - 산출 데이터 → 견적 내역서 형식으로 변환
   - 옵션 처리: 재료할증(%), 수량 소수점 자리, 1이하 포함 여부

2. popups/ 폴더에 estimate_options_popup.py 신규 파일 생성:
   - EstimateOptionsPopup(QDialog): 내역작성 옵션 설정 UI
   - 체크박스: 재료할증 넣기, 수량 1이하 넣기, 1:1 층별 작성
   - 콤보박스: 산출수량 소수점(정수/1자리/2자리), 결정수량 소수점
   - 라디오: 자료사전 단가 선택
   - 실행/취소 버튼

3. 변환 알고리즘:
   a. 전체 공종의 을지 데이터 순회
   b. 각 산출목록 + 일위대가 분해 → 개별 자재 리스트 생성
   c. 동일 자재 합산 (코드 기준)
   d. 재료할증 적용 (자료사전 DB의 재할 값)
   e. 수량 소수점 반올림
   f. 일위대가 속성 자재 분리 (별도 공종으로)
   g. 결과를 견적 데이터 구조로 생성

4. output_detail_tab.py 상단 메뉴에 "내역작성" 버튼 추가
   - 클릭 시 EstimateOptionsPopup 표시
   - 옵션 확인 후 변환 실행
   - 변환 완료 알림

[주의]
- 이 기능은 매우 복잡하므로 기본 구조만 먼저 구현
- 견적 파일 형식은 JSON으로 시작, 추후 이지테크 호환 포맷 추가
```

---

### PROMPT 4-2: 산출서 엑셀 변환

```
D:\오아시스\SANCHUL_Sheet_1 프로젝트에서 작업합니다.

[배경]
매뉴얼(p199-201)에 따르면:
- 산출서 내용을 엑셀 파일로 변환 가능
- 공종별 산출 내역서 형식으로 출력
- 산출목록, 산출수식, 계, 단위, 산출일위대가 내용 포함

[현재 상태]
- 엑셀 변환 기능 없음
- openpyxl 라이브러리 설치 필요할 수 있음

[요구 사항]
1. core/ 폴더에 excel_exporter.py 신규 파일 생성:
   - export_to_excel(project_data: dict, output_path: str) -> bool
   - openpyxl 사용 (없으면 pip install openpyxl)

2. 엑셀 시트 구성:
   - 시트 1: 산출 총괄표 (공종명, 수량 등)
   - 시트 2~N: 각 공종별 산출 내역서
     - 컬럼: 번호, 산출목록, 산출수식, 계, 단위, 비고
     - 산출일위대가: 해당 행 아래에 들여쓰기로 표시

3. 서식 적용:
   - 헤더: 배경색 #D9E1F2, 볼드
   - 테두리: thin border
   - 숫자: 오른쪽 정렬, 천단위 쉼표
   - 산출일위대가: 들여쓰기 + 연한 배경색

4. output_detail_tab.py 파일 메뉴에 연결:
   - "파일(F)" 메뉴 → "엑셀 변환" 항목
   - 저장 경로 다이얼로그 → 변환 실행 → 완료 알림

[주의]
- 한글 파일명/경로 지원
- 대량 데이터 시 메모리 효율 고려
- openpyxl 미설치 시 안내 메시지 표시
```

---

### PROMPT 4-3: 산식오류 검사

```
D:\오아시스\SANCHUL_Sheet_1 프로젝트에서 작업합니다.

[배경]
매뉴얼(p340)에 따르면:
- 총괄표에서 "산식검사" 버튼 → 전체 공종의 산출수식 일괄 검사
- 괄호 미닫힘 오류 등을 감지하여 보고
- 오류 위치(공종, 행번호) 표시 및 직접 이동 가능

[요구 사항]
1. core/ 폴더에 formula_checker.py 신규 파일 생성:
   - check_all_formulas(eulji_data: dict) -> list[dict]
   - 각 공종의 산출수식을 순회하며 오류 검출
   - 검사 항목: 괄호 짝, 연속 연산자, 빈 괄호, 잘못된 문자열
   - 반환: [{"gongjong": "1. 전등공사", "row": 5, "formula": "(3.5+", "error": "괄호 미닫힘"}]

2. popups/ 폴더에 formula_check_popup.py 신규 파일 생성:
   - FormulaCheckPopup(QDialog): 오류 목록 표시
   - 테이블: 공종명, 행번호, 산출수식, 오류내용
   - 행 더블클릭 → 해당 공종/행으로 이동

3. output_detail_tab.py 도구 메뉴에 "산식검사" 항목 추가
```

---

## ══════════════════════════════════════════════
## PHASE 5: 고급 기능
## ══════════════════════════════════════════════

---

### PROMPT 5-1: 산출판 시스템

```
D:\오아시스\SANCHUL_Sheet_1 프로젝트에서 작업합니다.

[배경]
매뉴얼(p165-171)에 따르면:
- 산출판은 한 화면에 500개의 산출목록을 배치하는 인덱스 시스템
- 10열 x 50행 그리드로 배치
- 인덱스 칸 클릭 → 대응하는 산출목록의 산출수식 입력으로 이동
- 여러 산출판을 생성/관리 가능 (리스트박스)
- F11 키로 셀 배경색 토글 (구분용)

[요구 사항]
1. popups/ 폴더에 calculation_board_popup.py 신규 파일 생성:
   - CalculationBoardPopup(QDialog): 산출판 메인 팝업
   - 좌측: 산출판 목록 리스트박스 (생성/삭제/이름변경 컨텍스트 메뉴)
   - 중앙: 산출목록 + 산출수식 세로 나열 (500개)
   - 우측: 10x50 인덱스 그리드 (클릭 시 좌측 해당 위치로 이동)

2. 인덱스 기능:
   - 방향키로 인덱스 내 이동
   - 인덱스 셀에 텍스트 입력 (타이핑 후 Enter)
   - 인덱스 셀 마우스 클릭 → 산출목록+수식 칸으로 커서 이동
   - F11 → 셀 배경 회색/흰색 토글

3. 산출판 → 을지 전송:
   - 산출판에서 작업 완료 후 "보내기" → 을지에 데이터 삽입
   - 산출목록, 산출수식, 산출일위대가 포함

4. Ctrl+B 단축키로 산출판 열기 (event_filter.py 추가)

5. data/templates/ 에 기본 산출판 데이터:
   - 전등(HFIX 2.5) 매입, 전열, 트레이 등 프리셋

[주의]
- 대형 UI이므로 성능 최적화 필요 (가상화 또는 지연로딩)
- 산출판 데이터는 프로젝트 파일에 별도 저장
```

---

### PROMPT 5-2: 간선 산출판 (전선-전선관 조합기)

```
D:\오아시스\SANCHUL_Sheet_1 프로젝트에서 작업합니다.

[배경]
매뉴얼(p172-179)에 따르면:
- 간선 산출판: 전선 종류, 규격, 가닥수, 접지, 전선관을 조합
- 5개 리스트박스 구조 (전선1 RST상, 전선2 N상, 전선3 접지, 지지금구, 전선관)
- 조합 결과 예: "F-CV 35sq-1/3c E-10(HI 42c)"
- F9: 경로명 입력, F10: 수식포함 저장전송, F11: 목록만 전송
- Tray/Lead 모드 전환
- 개별 자재 직접 산출 (네 번째 박스의 "개별" 버튼)

[요구 사항]
1. popups/ 폴더에 trunk_line_board_popup.py 신규 파일 생성:
   - TrunkLineBoardPopup(QDialog): 간선 산출판 팝업
   - 5개 리스트박스 쌍 (상: 전선 종류, 하: 규격)
   - 중앙: 체크박스 + 가닥수 스핀박스
   - 하단: 조합 결과 미리보기, 경로명 입력
   - 버튼: 저장(F10), 목록전송(#/F11), Tray, Lead, 개별

2. 자료사전 DB에서 전선/전선관 목록 로드:
   - WIRE.xxx, PIPE.xxx 그룹의 자재 추출
   - 리스트박스에 표시

3. 조합 알고리즘:
   - 선택된 전선+규격+가닥수+접지+전선관을 조합
   - 산출목록명 자동 생성 (예: "FCV 35sq-1/3c E-10(HI 42)")
   - 산출일위대가 자동 생성 (전선, 접지선, 전선관 각각 세부아이템)

4. 을지 전송: F10으로 을지에 산출목록+수식+일위대가 삽입
```

---

### PROMPT 5-3: 설계변경 관리

```
D:\오아시스\SANCHUL_Sheet_1 프로젝트에서 작업합니다.

[배경]
매뉴얼(p354-358)에 따르면:
- 산출수식 변경 시 "[]" 대괄호를 산출목록 앞에 붙여 변경 후 표시
- 변경 전 수식 유지 + 변경 분(증/감) 별도 행 추가
- 소요자재에서 변경 전/후 비교 가능
- 전체 도면 변경 시: 변경 전/후 파일 2개로 분리하여 관리

[요구 사항]
1. core/ 폴더에 design_change.py 신규 파일 생성:
   - mark_as_changed(item_name: str) -> str: "[]" 접두어 추가
   - is_changed_item(item_name: str) -> bool: "[]" 접두어 확인
   - calculate_change_diff(before: dict, after: dict) -> dict: 변경량 계산

2. output_detail_tab.py에서 설계변경 모드 지원:
   - "[]" 접두어 자동 감지 → 변경 후 항목으로 처리
   - 소요자재 집계 시 변경 전/후 구분

3. popups/ 폴더에 design_change_popup.py:
   - 변경 전/후 비교 화면
   - 증감 내역 요약
```

---

## ══════════════════════════════════════════════
## PHASE 6: 전문 기능 (장기)
## ══════════════════════════════════════════════

---

### PROMPT 6-1: 그림산출 인터페이스

```
D:\오아시스\SANCHUL_Sheet_1 프로젝트에서 작업합니다.

[배경]
매뉴얼(p151-163)에 따르면:
- 그림산출: 도면을 연상하는 직관적 UI로 산출
- 전등산출: 가닥수별 평면 → 귀로 → 기구(스위치, 조명기구)
- 전열산출: 회로별 평면 → 귀로 → 콘센트(말단/중간)
- 산출 결과를 을지로 자동 전송

[요구 사항]
1. popups/ 폴더에 graphic_calculation/ 서브폴더 생성:
   - lighting_calc_popup.py: 전등산출 그래픽 UI
   - outlet_calc_popup.py: 전열산출 그래픽 UI
   - base_graphic_calc.py: 공통 베이스 클래스

2. 전등산출 UI 구성:
   - 상단: 가닥수별 버튼 (2가닥, 3가닥, 4가닥...)
   - 중앙: 평면 수식 입력 영역
   - 하단 좌: 귀로 입력 (1회로, 2회로...)
   - 하단 우: 기구 입력 (스위치 1구~3구, 조명기구 종류)
   - 완료 버튼: "보내기" → 을지에 산출 결과 삽입

3. 산출 로직:
   - 가닥수 × 평면거리 → 배관/배선 산출
   - 귀로수 × 벽체높이 → 벽체 배관/배선 산출
   - 기구수 → 스위치/조명기구 산출
   - 구간접속 자동 계산

[주의]
- 이 기능은 가장 복잡한 UI이므로 단계적으로 구현
- 먼저 전등산출의 기본 틀만 구현, 이후 확장
```

---

### PROMPT 6-2: AutoCAD 연동 (선택적)

```
D:\오아시스\SANCHUL_Sheet_1 프로젝트에서 작업합니다.

[배경]
매뉴얼(p251-323)에 따르면:
- AutoCAD와 연동하여 도면에서 직접 물량 산출
- 개별산출: 배관/거리/기구 하나씩 산출
- 일괄산출: 색상별 전체 선택하여 일괄 산출
- 모델링산출: 기구 등록 → 시작선 선택 → 자동 산출

[참고]
- 이 기능은 AutoCAD COM API 또는 .NET API 필요
- Python에서는 pyautocad 또는 pywin32를 통한 COM 연동 가능
- 별도 모듈로 분리하여 AutoCAD 미설치 환경에서도 앱 정상 동작

[요구 사항]
- 이 기능은 현재 단계에서는 기획만 수행
- 추후 AutoCAD SDK 연동 가능 시 별도 프로젝트로 진행
- 현재는 수동 입력으로 대체 (캐드에서 측정한 값을 직접 입력)
```

---

## 진행 순서 요약

| 순서 | 프롬프트 | 핵심 내용 | 예상 소요 |
|------|----------|-----------|-----------|
| 1 | 1-1 | 수식 파서 | 30분 |
| 2 | 1-2 | Enter 연속입력 | 1시간 |
| 3 | 1-3 | Ctrl+C/V 복사붙이기 | 1시간 |
| 4 | 1-4 | F4 수량없이 입력 | 20분 |
| 5 | 2-1 | $H/$L 변수 대입 | 40분 |
| 6 | 2-2 | 세미콜론 수작업 입력 | 30분 |
| 7 | 2-3 | 구간접속 자동산출 | 1.5시간 |
| 8 | 2-4 | 기초작업 템플릿 | 1시간 |
| 9 | 3-1 | 소요자재 집계 | 2시간 |
| 10 | 3-2 | 일괄변경 도구 | 2시간 |
| 11 | 4-1 | 견적 변환 | 3시간 |
| 12 | 4-2 | 엑셀 변환 | 1.5시간 |
| 13 | 4-3 | 산식오류 검사 | 1시간 |
| 14 | 5-1 | 산출판 | 3시간 |
| 15 | 5-2 | 간선 산출판 | 3시간 |
| 16 | 5-3 | 설계변경 | 2시간 |
| 17 | 6-1 | 그림산출 | 5시간+ |
| 18 | 6-2 | AutoCAD (기획만) | - |
