# 오아시스 (OASIS) - egManual 기반 산출기능 구현 현황 및 계획서

## 참고 문서: egManual.pdf (산출기본 p137~201, 산출응용 p203~365, 일위대가 p585~621)

---

## 1. 이미 구현된 기능 (적용 완료)

### 1-1. 산출 내역서(을지) 기본 구조
| 항목 | 매뉴얼 참조 | 구현 상태 |
|------|-------------|-----------|
| 을지 컬럼: 번호, 구분, FROM, TO, 회로, 산출목록, 산출수식, 계, 단위, 비고 | p150 | ✅ 완료 |
| 산출목록 폭 400px, 산출수식 폭 432px | p150-151 | ✅ 완료 |
| 산출수식 → 계(TOTAL) 자동 계산 (eval 기반 사칙연산) | p150-151 | ✅ 완료 |
| 산출수식에 문자 포함 허용 (숫자만 추출 합산) | p206 | ⚠️ 부분 (eval 기반이므로 순수문자 포함 시 오류 가능) |
| 기본 500행 그리드 (자동 확장) | p166 | ✅ 완료 (DEFAULT_ROWS=500) |

### 1-2. 산출 일위대가 (산출일위표)
| 항목 | 매뉴얼 참조 | 구현 상태 |
|------|-------------|-----------|
| 보조 화면 (우측 팝업) 구조 | p141, 150-151 | ✅ 완료 |
| 최대 15개 세부아이템 | p151, 238 | ✅ 완료 (MAX_UNIT_PRICE_ROWS=15) |
| 컬럼: #., 산출일위목록, 단위수량, 단위계 | p141, 146 | ✅ 완료 |
| 산출목록 선택 시 자동 표시/숨김 | p168-169 | ✅ 완료 (unit_price_trigger) |
| F3 키로 토글 표시/숨김 | p168-169 | ✅ 완료 |
| Enter 키 → 산출일위표로 포커스 이동 | p221, 238 | ✅ 완료 |
| ESC 키 → 본 화면 복귀 | p169, 221 | ✅ 완료 |
| PageUp/PageDown → 상위 목록 이동 | p222 | ✅ 완료 |
| 단위수량 기본값 1 | p141 | ✅ 완료 |
| 단위수량 수식 지원 | p221, 238 | ✅ 완료 |

### 1-3. 블록 조작 (F5/F6/F7/F8)
| 항목 | 매뉴얼 참조 | 구현 상태 |
|------|-------------|-----------|
| F5 → 블록(범위) 지정 | p209-213 | ✅ 완료 |
| F6 → 복사 | p210-212 | ✅ 완료 |
| F7 → 이동 | p213-214 | ✅ 완료 |
| F8/ESC → 블록 해제 | p209 | ✅ 완료 |
| 줄(행) 단위 복사/이동 | p211-214 | ✅ 완료 |

### 1-4. 조각 파일
| 항목 | 매뉴얼 참조 | 구현 상태 |
|------|-------------|-----------|
| Ctrl+W → 블록 내용 파일로 보관 | p216-217 | ✅ 완료 |
| Ctrl+R → 조각 파일 불러오기 | p218-219 | ✅ 완료 |

### 1-5. 자료사전 연동
| 항목 | 매뉴얼 참조 | 구현 상태 |
|------|-------------|-----------|
| Tab 키 → 자료사전 팝업 열기 | p239-240 | ✅ 완료 |
| 자료 검색 (품명, 규격 등 전체검색) | p239-245 | ✅ 완료 |
| 산출목록(13) 우선 사용 (중복 방지) | p140-141 | ✅ 완료 (최근 수정) |
| 산출수량 입력 후 내역서 반영 | p239-240 | ✅ 완료 |
| 산출일위대가에서 자료사전 호출 | p240-241 | ✅ 완료 (_on_table_list_pick) |

### 1-6. 기본 편집 기능
| 항목 | 매뉴얼 참조 | 구현 상태 |
|------|-------------|-----------|
| Ctrl+N → 행 삽입 | p221 | ✅ 완료 |
| Ctrl+Y → 행 삭제 | p221 | ✅ 완료 |
| Ctrl+Z → 실행 취소 | - | ✅ 완료 (50단계) |
| 갑지/을지 전환 | p148-149 | ✅ 완료 |

### 1-7. 총괄표(갑지) 구조
| 항목 | 매뉴얼 참조 | 구현 상태 |
|------|-------------|-----------|
| 공종명, 수량, 층고($H), 천정내($L), 비고 컬럼 | p147-148 | ✅ 완료 |
| 공종 번호 → 내역서 이동 | p149 | ✅ 완료 |
| ESC → 을지에서 갑지로 복귀 | p149 | ✅ 완료 |
| 내역서 존재 표시 (*) | p149 | ✅ 완료 |

---

## 2. 미구현 기능 (추가 필요)

### 2-1. [우선순위 높음] 산출수식 고급 처리
| 항목 | 매뉴얼 참조 | 설명 | 난이도 |
|------|-------------|------|--------|
| Enter 연속입력 (40byte 초과 시 자동 줄 추가) | p155-157, 206 | 산출수식에서 Enter 입력 시 "+"를 추가하며, 40byte 초과 시 다음 줄에 이어서 입력. 합산 결과를 계에 반영 | ★★★ |
| 문자 포함 수식 안전 처리 | p206 | "2.3 + ↗ 2.3 + 귀로(2.9-1.8)" 같은 문자 포함 수식에서 숫자만 추출하여 계산 | ★★ |
| 괄호 수식 지원 | p206 | "(2.1+1.2)*4+1.2" 완전한 사칙연산 | ★★ |
| F4 → 수량 없이 입력 (1@ 표시) | p181 | 수량 없이 자료만 입력할 때 사용. "1@"이 산출수식에 자동 입력 | ★ |

### 2-2. [우선순위 높음] 구간접속 자동 산출
| 항목 | 매뉴얼 참조 | 설명 | 난이도 |
|------|-------------|------|--------|
| 구간접속 자동 계산 | p336-339 | 산출수식 분석하여 "+" 부호로 구분된 구간 수 계산 → 접속선 자동 산출 | ★★★★ |
| < > 꺽쇠 묶음 = 1구간 처리 | p337, 160 | `<2.1+6.3+1.2>` → 1구간으로 계산 | ★★★ |
| Ctrl+1~9 수동 구간 접속 | p340 | Ctrl + 숫자 → 위로 N줄의 구간을 합산하여 접속선 산출 | ★★★ |
| 접속선 버튼/자동생성 | p338 | 접속선 버튼 클릭 시 구간접속 데이터 생성 | ★★★ |

### 2-3. [우선순위 높음] 셀 복사/붙이기 기능
| 항목 | 매뉴얼 참조 | 설명 | 난이도 |
|------|-------------|------|--------|
| Ctrl+C / Ctrl+V 셀 복사 붙이기 | p206-208 | 단일 셀 및 다중 셀 선택 복사/붙이기 | ★★ |
| Ctrl+X 잘라내기 | p214 | 잘라내기 후 이동 | ★★ |
| 끌기 복사 (드래그 핸들) | p208 | 셀 우측 하단 핸들로 드래그하여 복사 | ★★★ |
| 파일 간 복사 붙이기 | p214-215 | 다른 파일의 데이터를 Ctrl+V로 붙이기 | ★★ |

### 2-4. [우선순위 중간] 000. 기초작업 시스템
| 항목 | 매뉴얼 참조 | 설명 | 난이도 |
|------|-------------|------|--------|
| 000. 기초작업 공종 자동 생성 | p143-144, 219-220 | 파일 생성 시 조명기구/분전반 기본 데이터 포함 공종 자동 생성 | ★★★ |
| 조명기구 일위대가 템플릿 (4각/8각 BOX) | p220-221 | A-Type, B-Type 등 조명기구별 11개 세부아이템 프리셋 | ★★★ |
| 분전반 수작업용/일위대가용 분리 | p222, 233-234 | 수작업용 = 일반자재, 일위대가용 = 세부내역 필요 | ★★ |
| $H/$L 변수 대입 | p147-148, 250-251 | 층고/천정내 높이 값을 산출수식에 자동 대입 | ★★★ |
| @ 기호 → 산출일위대가 명칭 연동 | p229 | 산출목록명 변경 시 일위대가 첫 줄도 연동 변경 | ★★ |
| # 기호 → 일위대가 속성 지정 | p229 | 견적 변환 시 일위대가로 자동 등록 | ★★ |

### 2-5. [우선순위 중간] 목록 집계 및 일괄 변경
| 항목 | 매뉴얼 참조 | 설명 | 난이도 |
|------|-------------|------|--------|
| 전체 목록 집계하기 | p344-346 | 모든 공종의 산출목록을 하나로 취합 | ★★★ |
| 산출 보조 내용 일괄 바꾸기 | p346-348 | 집계된 목록에서 일위대가 내용 수정 → 전체 공종에 반영 | ★★★★ |
| 을지 일부 자료 산출수량 증감 | p349-350 | 특정 자재의 수량을 비율(%)로 증감 | ★★ |
| 특정 산출목록 일괄 제거 | p350-351 | 여러 공종에서 특정 자재를 한꺼번에 삭제 | ★★ |
| 자재 재질 일괄 변경 | p359-363 | HI → ST 등 재질 변경을 전체 공종에 적용 | ★★★ |

### 2-6. [우선순위 중간] 소요자재 관리
| 항목 | 매뉴얼 참조 | 설명 | 난이도 |
|------|-------------|------|--------|
| 소요자재 집계 보기 | p191-192, 341-342 | 파일 전체 사용 자재 목록 집계 표시 | ★★★ |
| 새로고침 기능 | p192 | 산출 결과 재집계 | ★★ |
| ReMast (자료사전 정보 재적용) | p192, 203 | DB 최신 정보로 업데이트 | ★★ |
| 근거추적 | p192 | 특정 자재가 어느 공종에서 산출되었는지 추적 | ★★★ |
| Txt 파일 변환 | p192 | 엑셀 호환 텍스트 파일로 변환 | ★ |

### 2-7. [우선순위 중간] 산출 → 견적 변환
| 항목 | 매뉴얼 참조 | 설명 | 난이도 |
|------|-------------|------|--------|
| 내역작성 버튼 (산출 → 견적 변환) | p192-195 | 산출 데이터를 견적 내역서로 자동 변환 | ★★★★★ |
| 재료할증 옵션 | p193 | 자료사전 등록 재할(10% 등) 자동 가산 | ★★★ |
| 수량 소수 조정 옵션 | p193 | 정수/소수 1자리/소수 2자리 선택 | ★ |
| 수량 1 이하 처리 옵션 | p193 | 0.4 같은 미소수량 포함/제외 | ★ |
| 1:1(층별) 작성 옵션 | p194 | 계층 무시 공종별 작성 | ★★ |
| 기존 단가 재사용 옵션 | p194-195 | 재변환 시 이전 단가/품셈 유지 | ★★★ |

### 2-8. [우선순위 낮음] 산출판 시스템
| 항목 | 매뉴얼 참조 | 설명 | 난이도 |
|------|-------------|------|--------|
| 산출판 인덱스 (500개 배치) | p165-167 | 10x50 그리드에 산출목록 배치 | ★★★★ |
| 인덱스 클릭 → 산출 입력 | p167-168 | 클릭 시 산출수식 칸으로 이동 | ★★★ |
| 새로운 산출판 만들기/이름변경 | p170 | 리스트박스 우측클릭 메뉴 | ★★ |
| F11 → 인덱스 셀 색상 토글 | p167 | 구분용 회색/흰색 전환 | ★ |

### 2-9. [우선순위 낮음] 간선 산출판
| 항목 | 매뉴얼 참조 | 설명 | 난이도 |
|------|-------------|------|--------|
| 전선-전선관 조합기 | p172-176 | 5개 리스트박스 기반 전선/관 조합 | ★★★★ |
| F9 → 경로명 입력 후 을지 전송 | p176 | 경로명 쓰고 Enter/F9로 입력 | ★★ |
| F10 → 저장(산식 포함 전송) | p177 | 산식+목록 을지로 전송 | ★★ |
| F11 → 목록만 전송(#) | p177 | 산식 없이 목록만 전송 | ★★ |
| Tray/Lead 전환 | p178 | 전선관 대신 Tray/Lead 표시 | ★ |
| 개별 자재 직접 산출 | p178-179 | 간선산출 중 단일자재 산출 | ★★ |

### 2-10. [우선순위 낮음] 그림산출
| 항목 | 매뉴얼 참조 | 설명 | 난이도 |
|------|-------------|------|--------|
| 전등산출 그림 인터페이스 | p151-159 | 가닥별 평면산출 → 귀로 → 기구 | ★★★★★ |
| 전열산출 그림 인터페이스 | p160-163 | 회로별 평면산출 → 귀로 → 콘센트 | ★★★★★ |
| 산출판/그림산출 전환 | p152-153 | 산출판과 그림산출의 기능 차이 관리 | ★★★ |

### 2-11. [우선순위 낮음] AutoCAD 연동
| 항목 | 매뉴얼 참조 | 설명 | 난이도 |
|------|-------------|------|--------|
| 캐드 개별산출 네비게이터 | p251-270 | 배관/거리/기구 산출 도구 | ★★★★★ |
| 캐드 일괄산출 네비게이터 | p273-316 | 색상별 일괄 선택 산출 | ★★★★★ |
| 모델링 산출 | p308-316 | 기구 등록 → 시작선 → 자동 산출 | ★★★★★ |
| 블록화 도구 | p319-323 | 비블록 기구 일괄 블록화 | ★★★ |

### 2-12. [우선순위 낮음] 기타 고급 기능
| 항목 | 매뉴얼 참조 | 설명 | 난이도 |
|------|-------------|------|--------|
| 산출의 설계변경 | p354-358 | [] 대괄호 표기 → 변경 전/후 비교 | ★★★★ |
| 산출서 인쇄/미리보기 | p197-199 | 공종트리, 목차, 집계표, 세부산출서 | ★★★★ |
| 산출 엑셀 변환 | p199-201 | 엑셀 파일로 변환 출력 | ★★★ |
| 산식오류 검사 | p340 | 괄호 미닫힘 등 산식 오류 검출 | ★★ |
| Ctrl+PgUp/PgDn → 다른 공종 이동 | p149 | 을지 간 직접 이동 | ★ |
| 산출사전/산출복제 (표준공종) | p329-334 | 표준 공종 템플릿 기반 작업 | ★★★ |
| 내 현장 전용 자료사전 | p472-476 | 현장별 DB 분리 관리 | ★★★ |
| 즐겨찾기 | p246-248 | 자주 사용하는 자재 목록 관리 | ★★ |
| 최근사용자료 | p243 | 최근 사용 자재 빠른 접근 | ★★ |
| 수작업 자재 입력 (명칭;규격;단위) | p182-183 | 세미콜론 구분 수작업 입력 | ★ |
| F2/Insert → 셀 내용 수정모드 | p206 | 기존 내용 수정 진입 | ★ |
| 공용/전용 일위대가 관리 | p585-621 | 일위대가 생성/수정/등록/갈무리 | ★★★★ |

---

## 3. 구현 우선순위 로드맵

### Phase 1: 핵심 산출 기능 강화 (즉시 착수)
1. **산출수식 Enter 연속입력** - 40byte 초과 시 자동 줄 추가/합산
2. **Ctrl+C/Ctrl+V 셀 복사/붙이기** - 단일/다중 셀 지원
3. **문자 포함 수식 안전 처리** - 숫자만 추출하여 합산
4. **F4 수량 없이 입력** - "1@" 자동 입력

### Phase 2: 산출 효율화 기능 (1~2주)
5. **구간접속 자동 계산** - 수식 분석 → 구간 수 산출 → 접속선 생성
6. **$H/$L 변수 대입** - 총괄표 층고/천정내 → 수식/일위대가에 치환
7. **000. 기초작업 템플릿** - 조명기구/분전반 프리셋 데이터
8. **수작업 자재 입력 (명칭;규격;단위)** - 세미콜론 파싱

### Phase 3: 집계/관리 기능 (2~3주)
9. **소요자재 집계** - 전체 사용 자재 목록 보기/수정
10. **전체 목록 집계** - 공종 간 산출목록 취합
11. **일괄 변경 도구** - 재질 변경, 수량 증감, 목록 제거
12. **근거추적** - 자재별 사용 공종 추적

### Phase 4: 출력/변환 기능 (3~4주)
13. **산출 → 견적 변환 (내역작성)** - 핵심 비즈니스 기능
14. **인쇄/미리보기** - 산출서 서식 출력
15. **엑셀 변환** - 산출서 엑셀 내보내기
16. **산식오류 검사** - 괄호 등 구문 오류 검출

### Phase 5: 고급 기능 (장기)
17. **산출판 시스템** - 500개 인덱스 기반 산출 도구
18. **간선 산출판** - 전선-전선관 조합기
19. **설계변경** - 변경 전/후 비교 관리
20. **일위대가 관리** - 공용/전용 일위대가 생성/등록

### Phase 6: 전문 기능 (미래)
21. **그림산출 인터페이스** - 전등/전열 그림 기반 산출
22. **AutoCAD 연동** - 캐드 도면 기반 산출 (별도 모듈)

---

## 4. 현재 코드 수정 필요 사항

### 4-1. 산출수식 계산 로직 개선
- **현재**: `eval()` 기반 → 문자 포함 시 에러 발생
- **개선**: 숫자/연산자만 추출하는 파서 구현 필요
- **참고**: 매뉴얼 p206 "식의 중간에 이해를 돕기 위한 문자도 허용"

### 4-2. 산출수식 40byte 제한 및 자동 줄 추가
- **현재**: 한 줄에 무제한 입력 가능
- **개선**: 40byte 초과 시 다음 행에 자동 연결, 합산 결과 반영
- **참고**: 매뉴얼 p155-157, 206 "Enter키로 40byte 넘으면 자동 줄 추가"

### 4-3. 산출일위대가 마크(#.) 열 기능 확장
- **현재**: 단순 표시용 (i 마크)
- **개선**: 자료 속성 구분 필요 (-, -*, i*, i, +, +*, #)
- **참고**: 매뉴얼 p441-442 자료 속성 표시 체계

### 4-4. 총괄표 $H/$L 변수 시스템
- **현재**: 컬럼은 존재하지만 변수 치환 미구현
- **개선**: 산출수식 및 일위대가 수식에서 $H, $L 값 자동 대입
- **참고**: 매뉴얼 p147-148, 250-251

---

## 5. 참고 단축키 매핑 현황

| 단축키 | 매뉴얼 기능 | 앱 구현 상태 |
|--------|------------|--------------|
| Tab | 자료사전 열기 | ✅ 구현됨 |
| Ctrl+Tab | 산출사전/내현장 불러오기 | ❌ 미구현 |
| F2/Insert | 셀 수정모드 진입 | ⚠️ 기본 Qt 동작 |
| F3 | 산출일위대가 토글 / 수식없는 줄 삭제 | ⚠️ 토글만 구현 |
| F4 | 수량 없이 입력 (1@ 표시) | ❌ 미구현 |
| F5 | 블록 범위 지정 | ✅ 구현됨 |
| F6 | 블록 복사 | ✅ 구현됨 |
| F7 | 블록 이동 | ✅ 구현됨 |
| F8 | 블록 해제 | ✅ 구현됨 |
| F9 | 현재화면복사/경로명입력 | ✅ 구현됨 (클립보드 복사) |
| F10 | 붙이기/저장전송 | ✅ 구현됨 (붙이기) |
| F11 | 자료사전/색상토글 | ✅ 구현됨 (자료사전) |
| Ctrl+C/V | 셀 복사/붙이기 | ❌ 미구현 (행 복사만) |
| Ctrl+X | 잘라내기 | ❌ 미구현 |
| Ctrl+N | 행 삽입 | ✅ 구현됨 |
| Ctrl+Y | 행 삭제 | ✅ 구현됨 |
| Ctrl+Z | 실행취소 | ✅ 구현됨 |
| Ctrl+W | 조각파일 저장 | ✅ 구현됨 |
| Ctrl+R | 조각파일 불러오기 | ✅ 구현됨 |
| Ctrl+B | 산출판 열기 | ❌ 미구현 |
| Ctrl+T | 자재합산하기 | ❌ 미구현 |
| Ctrl+1~9 | 수동 구간접속 | ❌ 미구현 |
| Ctrl+PgUp/PgDn | 다른 공종 이동 | ❌ 미구현 |
| PageUp/PageDown | 산출일위표 목록 이동 | ✅ 구현됨 |
| Enter | 산출수식 연속입력(+추가) | ⚠️ 부분구현 |
| ESC | 을지→갑지 전환 | ✅ 구현됨 |

---

**작성일**: 2025-02
**기준 문서**: egManual.pdf (709페이지)
**분석 범위**: 산출기본(p137-201), 산출응용(p203-365), 일위대가(p585-621)
**앱 버전**: SANCHUL_Sheet_1 (PyQt6 기반)
