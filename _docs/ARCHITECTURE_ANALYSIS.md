# 산출 시스템 아키텍처 분석 리포트
**작성일**: 2026-01-31  
**대상**: 오아시스 (OASIS) - 전기 설비 산출 시스템

---

## 1. 요구사항 vs 현재 구현 상태 매핑

### ✅ 구현 완료 (또는 진행 중)

#### 1.1 기본 구조
- [x] **3계층 UI 아키텍처**
  - 메인 화면: `OutputDetailTab` (산출내역서 시트)
  - 1차 패널: 좌측 "산출공종 선택 리스트 패널"
  - 2차 창: `LightingPowerPopup` (세부산출조서 팝업)
  - 3차 창: 자료사전 DB 팝업 (개발 진행 중)

#### 1.2 핵심 컴포넌트
- [x] **Master-Detail 2분할**: `LightingPowerPopup`에서 좌측(산출목록) / 우측(산출일위) 패널 구성
- [x] **자료사전 DB 연동**: `자료사전.db` 경로 설정됨 (`D:\이지맥스\data\자료사전.db`)
- [x] **CODE 기반 매칭**: 자료사전에서 CODE 로드 (`_load_reference_codes()`)

#### 1.3 입력/편집 기능
- [x] **키보드 단축키**:
  - `Ctrl+N`: 행 삽입
  - `Ctrl+Y`: 행 삭제
  - 다중 선택 (F5, F6, F7, F4로 추정)
- [x] **사칙연산 수식 계산**: `evaluate_math()` 함수로 단위수식 계산
- [x] **Undo 스택**: 작업 기록 및 취소 기능

---

### ⚠️ 부분 구현 (불완전)

#### 2.1 W 컬럼 (검증 상태 표시)
**현재 상태**: 기본 구조만 존재
```
구현됨:
- [x] CODE 매칭 검증 로직 시작 (_load_reference_codes)
- [x] reference_codes 세트 구성

미완료:
- [ ] W 컬럼 텍스트 생성 규칙 (--/~*/~i/-i-/**)
- [ ] 일위대가(i) 판정 기준 구현
- [ ] 색상 표시 (짙은 청색, 붉은색 등)
```

#### 2.2 자료사전 팝업 (3차 창)
**현재 상태**: 구조만 시작
```
구현됨:
- [x] 팝업 창 생성 기본 틀
- [x] DB 연결 및 CODE 로드

미완료:
- [ ] TAB 키 호출 이벤트 핸들링
- [ ] 팝업의 컬럼 구성 (ID, 품목, 규격, 단위, CODE, 수량)
- [ ] 수량 컬럼의 이중 기능 (숫자 vs 텍스트)
- [ ] 검색 기능 (Enter 입력 시 검색 및 행 이동)
- [ ] 보내기 버튼 / ESC 키 데이터 전송
```

#### 2.3 수동 CODE 매칭 (=== 기능)
**현재 상태**: 미구현
```
요구사항:
- [ ] 자료사전 팝업 상단에 산출일위 품목 리스트 표시
- [ ] active_target 설정 기능
- [ ] === 수식 입력 시 CODE 강제 연결
- [ ] 원본 데이터에 CODE 저장 및 영구 보존
```

---

### ❌ 미구현 (필수)

#### 3.1 1식(묶음) 산출 저장
**요구사항 문서 섹션 10**
```
- [ ] 세부산출조서 종료 시 산출내역서 해당 행에 저장:
  산출목록 = 선택된 공종명
  산출수식 = 1
  계 = 세부산출조서 최종 합계
  단위 = 식
```

#### 3.2 조각파일 (.piece) 기능
**요구사항 문서 섹션 6.3**
```
- [ ] F9: 선택한(다중) 행을 조각파일로 저장
- [ ] 외부 조각파일 불러오기 및 재사용
- [ ] 파일 포맷 정의 (미확정: JSON? CSV? 이진?)
```

#### 3.3 재진입 (재편집) 기능
**요구사항 문서 섹션 10.3**
```
- [ ] 산출내역서에서 TAB 키로 재진입
- [ ] 이전 편집 상태 복구 (행 위치, 데이터 등)
- [ ] 세부산출조서 데이터 다시 로드
```

#### 3.4 검색 기능 (자료사전 내)
**요구사항 문서 섹션 7.4.2**
```
- [ ] 자료사전 팝업의 "수량" 컬럼에 텍스트 입력
- [ ] Enter 입력 시 다음 컬럼에서 검색:
  그룹, 목록2~6, 약칭, W, 산출목록, 검색목록
- [ ] 검색 결과 행으로 자동 스크롤/이동
```

#### 3.5 데이터 전송 규칙 (자료사전 → 산출일위)
**요구사항 문서 섹션 7.4.1**
```
- [ ] 보내기 버튼 또는 ESC 키 실행 시 전송:
  자료사전.품목 → 산출일위.산출목록
  자료사전.수량 → 산출일위.단위수식
  (계 = 이 값들을 기준으로 자동 계산)
```

---

## 2. 아키텍처 구조 검증

### 2.1 파일/폴더 구조
```
OutputDetail_Standalone/
├── main.py ────────────────────── ✅ 진입점 (수정 완료)
├── output_detail_tab.py ────────── ✅ 산출내역서 메인 UI
├── lighting_power_manager.py ─────── ⚠️ 세부산출조서 팝업 (부분 구현)
├── core/
│   └── app_style.py ────────────── ✅ 스타일 및 폰트 로드
├── utils/
│   ├── column_settings.py ──────── ✅ 컬럼 정의 및 설정
│   └── grid_clipboard.py ───────── ✅ 클립보드 핸들링
└── data/
    └── 자료사전.db ────────────── ✅ 참조 DB (존재함)
```

### 2.2 클래스 계층 구조
```
QMainWindow (main.py)
  └── OutputDetailTab (output_detail_tab.py)
       ├── gapji_table (갑지 - 산출내역서 메인)
       ├── gongjong_list (우측 패널 - 공종 선택)
       └── LightingPowerManager
            └── LightingPowerPopup (세부산출조서 팝업)
                 ├── master_table (좌측 산출목록)
                 └── detail_table (우측 산출일위)
                      └── (3차) 자료사전 팝업 (미구현)
```

---

## 3. 데이터 흐름 검증

### 3.1 구현된 흐름
```
1. main.py 시작
   ↓
2. OutputDetailTab.create_tab() 호출
   ↓
3. 갑지(산출내역서) + 좌측 공종 리스트 표시
   ↓
4. 공종 선택
   ↓
5. LightingPowerPopup (세부산출조서) 호출 ✅
   - 좌측: 산출목록 (Master)
   - 우측: 산출일위 (Detail)
```

### 3.2 미완료 흐름
```
6. 산출일위의 어느 행/컬럼에서든 TAB 키 ❌
   ↓
7. 자료사전 DB 팝업 호출 ❌
   - 팝업 상단: 산출일위 품목 리스트 표시 ❌
   ↓
8. 수량 입력 (숫자 또는 텍스트) ❌
   ↓
   8-1. 숫자 → 보내기/ESC → 데이터 전송 ❌
   8-2. 텍스트 → Enter → 검색 및 이동 ❌
   8-3. === → Enter → 수동 CODE 매칭 ❌
   ↓
9. 세부산출조서 종료 → 산출내역서에 1식 저장 ❌
```

---

## 4. 데이터베이스 스키마 확인 필요

**자료사전.db** - 다음 테이블/컬럼이 존재한다고 가정:
```sql
[자료사전] 테이블:
  - ID (일련번호)
  - 품목 (품목명)
  - 규격 (사양)
  - 단위 (수량 단위)
  - CODE (고유키 - 매칭 포인트) ✅ 현재 로드됨
  - 그룹 (검색 기준)
  - 목록2~6 (검색 기준)
  - 약칭 (검색 기준)
  - W (검증 상태 필드?)
  - 산출목록 (품목명 파생?)
  - 검색목록 (검색 기준)

현재 확인: CODE 컬럼만 로드되어 있음 ✅
미확인: 다른 컬럼 존재 여부, 테이블 분리 여부
```

---

## 5. 미확정/추정 항목 (사용자 문서 섹션 13 참고)

| 항목 | 상태 | 확정 필요 사항 |
|------|------|---|
| 자료사전.db 테이블명/스키마 | ❓ 추정 | 실제 테이블 분리, 컬럼명 확인 |
| 일위대가(i) 판정 기준 | ❌ 미정 | 어느 컬럼/값으로 판정할지 |
| 조각파일 (.piece) 포맷 | ❌ 미정 | JSON/CSV/이진 중 선택 |
| === 수동 매칭 저장 위치 | ❌ 미정 | 엑셀/DB/메모리 중 선택 |
| 미매칭(~*) 저장 정책 | ❌ 미정 | 저장 차단/경고/허용 중 선택 |

---

## 6. 권장 개선 우선순위

### 🔴 **1순위 (필수)**
1. **TAB 키 이벤트 핸들**: 산출일위 any 셀에서 TAB → 자료사전 팝업 호출
2. **자료사전 팝업 구성**: 6개 컬럼 + 상단 품목 리스트 구현
3. **데이터 전송 로직**: 자료사전 → 산출일위 매핑 규칙 구현
4. **W 컬럼 표시**: CODE 매칭 결과 (--/~*/~i/-i-/**) 표시

### 🟠 **2순위 (중요)**
5. **수동 CODE 매칭** (=== 기능): active_target 선택 및 강제 연결
6. **1식 저장 로직**: 세부산출조서 종료 시 산출내역서 반영
7. **검색 기능**: 텍스트 입력 → Enter → 검색 및 이동
8. **색상 강조**: 일위대가(청색), 미매칭(빨강)

### 🟡 **3순위 (선택)**
9. 조각파일 (.piece) 저장/불러오기 (F9)
10. 재진입 시 상태 복구
11. 실시간 계산 프리뷰
12. Ctrl+S, Ctrl+Z/Redo 등 추가 단축키

---

## 7. 코드 품질 메모

### 좋은 점 ✅
- 경로 설정 명확화 (main.py)
- 예외 처리 개선 (msgbox, import 에러)
- 사칙연산 계산 (evaluate_math) 안전하게 구현
- Undo 스택으로 작업 기록

### 개선 필요 사항 ⚠️
- `LightingPowerPopup` 클래스가 너무 큼 (683줄) → 분리 필요
- 자료사전 팝업 미완료 → 별도 클래스로 분리 권장
- DB 스키마 하드코딩 → 설정 파일로 외부화 권장
- 테스트 코드 부재

---

## 8. 결론

**현재 상태**: 기본 아키텍처 구축됨, 핵심 기능 40% 구현

**즉시 필요한 작업**:
1. 자료사전 팝업 완성 (3차 창)
2. TAB 키 이벤트 핸들링 + 팝업 호출
3. 데이터 전송 규칙 구현
4. W 컬럼 검증 표시 로직

**추가 확인 필요**:
- 자료사전.db 실제 스키마 검사
- 일위대가 판정 기준 (어떤 컬럼?)
- 저장 정책 (엑셀 vs DB vs 메모리)
