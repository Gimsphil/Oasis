# 산출 시스템 실행 분석 보고서
**생성일**: 2026-01-31  
**분석 대상**: 오아시스 (OASIS) - 전기 설비 산출 시스템
**상태**: 기본 아키텍처 구축, 핵심 기능 부분 구현

---

## 📊 1. 현재 구현 현황 (요구사항 대비)

### ✅ 완벽하게 구현된 부분 (40%)

| 섹션 | 항목 | 상태 | 코드 위치 |
|------|------|------|---------|
| **1. 시스템 개요** | 3계층 UI 구조 | ✅ | output_detail_tab.py:150 |
| **1.2 핵심 원칙** | CODE 기반 데이터 일원화 | ✅ | lighting_power_manager.py:76 |
| **2.1 메뉴 경로** | 전등/전열 메뉴 | ✅ | lighting_power_manager.py |
| **3.1 패널 구조** | Master-Detail 2분할 | ✅ | lighting_power_manager.py:93-175 |
| **4. 산출목록 패널** | 좌측 Master 테이블 | ✅ | lighting_power_manager.py:101 |
| **5. 산출일위 패널** | 우측 Detail 테이블 (W/CODE/산출목록/단위수식/계) | ✅ | lighting_power_manager.py:135 |
| **6.1 행 편집** | Ctrl+N, Ctrl+Y 단축키 | ✅ | output_detail_tab.py:67-90 |
| **사칙연산** | 단위수식 계산 | ✅ | lighting_power_manager.py:20 |

---

### ⚠️ 부분 구현 또는 미완료 (60%)

#### **A. TAB 키 → 자료사전 팝업 호출 (필수 우선순위 1순위)**
```
상태: ❌ 미구현

요구사항:
- 산출일위 패널의 어느 행/어느 컬럼에서든 TAB 키
- → 자료사전 DB 팝업 호출

현재 코드:
- output_detail_tab.py:130에 주석으로만 "Tab 키: 공종명 컬럼에서 을지로 이동 (추가)" 있음
- 실제 TAB 키 이벤트 핸들러 없음
- detail_table에 installEventFilter 없음

구현 필요:
1. LightingPowerPopup.__init__에서 detail_table에 KeyEventFilter 설치
2. QEvent.Type.KeyPress 감지 시 Qt.Key.Key_Tab 확인
3. 자료사전 팝업(3차 창) 호출
```

#### **B. 자료사전 팝업 (3차 창) (필수 우선순위 2순위)**
```
상태: ❌ 미구현

요구사항 (섹션 7):
- 팝업 창 형태
- 컬럼: ID, 품목, 규격, 단위, CODE, 수량 (6개)
- 상단: 산출일위 품목 리스트 (active_target 선택용)
- 리스트 텍스트: 진한 녹색
- 가로/세로 그리드 표시

현재 코드:
- LightingPowerPopup 클래스만 있고, 자료사전 팝업 클래스 없음
- ref_db_path 설정만 있음 (D:\이지맥스\data\자료사전.db)
- reference_codes 로드만 함 (CODE 컬럼 일부만)

구현 필요:
1. DatabaseReferencePopup 또는 유사 클래스 생성
2. 자료사전 테이블 전체 로드 (모든 컬럼)
3. 상단 품목 리스트 구성
4. QTableWidget 또는 QTableView로 데이터 표시
```

#### **C. 데이터 전송 규칙 (자료사전 → 산출일위) (필수 우선순위 3순위)**
```
상태: ❌ 미구현

요구사항 (섹션 7.4.1 & 7.4.2):
- 숫자 입력: 산출수량 입력 → 보내기/ESC → 전송
  * 자료사전.품목 → 산출일위.산출목록
  * 자료사전.수량 → 산출일위.단위수식
  * 계 = 단위수식 계산값
  
- 텍스트 입력: 검색어 → Enter → 검색 및 이동
  * 그룹, 목록2~6, 약칭, W, 산출목록, 검색목록에서 검색
  * 매칭 행으로 자동 스크롤

현재 코드:
- 전송 로직 전무
- 검색 기능 전무
- 데이터 연동 규칙 전무

구현 필요:
1. 자료사전 팝업의 보내기 버튼 이벤트
2. ESC 키 캡처
3. 데이터 검증 (숫자 vs 텍스트 구분)
4. 산출일위로 데이터 전송
5. 검색 기능 (검색어 → Enter → 행 이동)
```

#### **D. W 컬럼 검증 표시 (필수 우선순위 4순위)**
```
상태: ⚠️ 부분 구현

요구사항 (섹션 5.2):
- -- : CODE 매칭 성공 (일반 품목)
- ~* : CODE 매칭 실패 (자료사전에 없음)
- -i- : CODE 매칭 성공 (일위대가 품목)
- ~i : CODE 매칭 실패 (일위대가 품목)
- ** : CODE 컬럼 빈값

색상:
- i 행(일위대가) = 텍스트 짙은 청색

현재 코드:
- reference_codes 세트 로드만 함 (lighting_power_manager.py:76)
- 실제 매칭 로직 없음
- W 컬럼에 값을 쓰는 코드 없음
- 일위대가 판정 로직 없음

구현 필요:
1. _check_code_match() 함수 작성
2. detail_table의 각 행에 대해 CODE 컬럼 확인
3. reference_codes와 매칭
4. W 컬럼에 값 입력 (--/~*/-i-/~i/**)
5. 일위대가 판정 기준 확정 (어느 컬럼/값?)
6. 색상 처리 (청색 등)
```

#### **E. 수동 CODE 매칭 (=== 기능) (우선순위 2순위)**
```
상태: ❌ 미구현

요구사항 (섹션 9):
- 자료사전 팝업 상단: 산출일위 품목 리스트
- 사용자 선택 → active_target 설정
- 자료사전 행의 수량 컬럼에 === 입력
- Enter → 해당 행의 CODE를 active_target의 CODE에 저장
- 원본 데이터에 영구 저장
- W 상태 즉시 재검증

예외 처리:
- active_target 미선택 상태 → 경고
- 기존 CODE 있는 행에 재매칭 → 경고/정책 미정

현재 코드:
- active_target 개념 없음
- === 입력 감지 없음
- CODE 강제 연결 로직 없음
- 영구 저장 로직 없음

구현 필요:
1. active_target 변수 추가
2. 산출일위 품목 리스트 UI
3. === 입력 감지
4. CODE 저장 로직
5. W 컬럼 재검증
6. 경고 다이얼로그
```

#### **F. 1식 저장 (필수 우선순위 5순위)**
```
상태: ❌ 미구현

요구사항 (섹션 10):
- 세부산출조서 종료 시 (ESC 또는 내보내기 버튼)
- 산출내역서 해당 행에 다음 저장:
  * 산출목록 = 선택된 공종명 (예: "전등수량(갯수)산출")
  * 산출수식 = 1
  * 계 = 세부산출조서 최종 합계
  * 단위 = 식

현재 코드:
- LightingPowerPopup.accept/reject 있음 (하단 버튼)
- 하지만 산출내역서로 데이터 전송 로직 없음
- 부모 윈도우와의 데이터 연동 없음

구현 필요:
1. accept() 또는 신규 메서드에서 데이터 수집
2. 부모 OutputDetailTab에 신호/슬롯 또는 콜백
3. 산출내역서(gapji_table) 해당 행 업데이트
4. ESC 키 감지 및 처리
```

#### **G. 조각파일 (.piece) 기능 (우선순위 3순위)**
```
상태: ❌ 미구현

요구사항 (섹션 6.3):
- F9: 선택한(다중) 행을 조각파일로 저장
- 파일 포맷: 미확정 (JSON? CSV? 이진?)
- 불러오기: 외부 조각파일 로드 및 재사용

현재 코드:
- F9 키 감지 없음
- 파일 저장 로직 없음
- 템플릿 기능 없음

구현 필요:
1. 파일 포맷 결정
2. F9 키 감지
3. 다중 선택 행 추출
4. 파일로 저장
5. 불러오기 UI
```

#### **H. 재진입 (재편집) 기능 (우선순위 3순위)**
```
상태: ❌ 미구현

요구사항 (섹션 10.3):
- 산출내역서에서 TAB 키로 재진입
- 이전 편집 상태 복구 (행 위치, 데이터 등)
- 세부산출조서 데이터 다시 로드

현재 코드:
- 초기 데이터 저장 (set_data 메서드)
- 하지만 재진입 시 복원 로직 없음
- initial_data 사용 안 함

구현 필요:
1. initial_data 활용
2. 세부산출조서 재로드 시 이전 데이터 복원
3. 커서 위치 복구
```

---

## 🔴 2. 필수 미확정 사항 (사용자 문서 섹션 13)

| 항목 | 영향도 | 현황 | 해결 필요 |
|------|--------|------|---------|
| 자료사전.db 테이블명/스키마 | 🔴 높음 | 부분 확인 (CODE 컬럼만) | DB 상세 검사 필요 |
| 일위대가(i) 판정 기준 | 🔴 높음 | 미정 | 어느 컬럼/값인지 명시 필요 |
| 조각파일 (.piece) 포맷 | 🟡 중간 | 미정 | JSON/CSV/이진 중 선택 필요 |
| 수동 매칭 저장 위치 | 🔴 높음 | 미정 | 엑셀/DB/메모리 중 선택 필요 |
| 미매칭(~*) 저장 정책 | 🟡 중간 | 미정 | 저장 차단/경고/허용 중 선택 필요 |
| 그룹, 목록2~6 컬럼 | 🟡 중간 | 추정 | 자료사전.db에 존재하는지 확인 필요 |

---

## 📁 3. 파일 구조 및 역할

```
OutputDetail_Standalone/
│
├── main.py ✅ 완성
│   ├ 경로 설정 (명확화)
│   ├ 예외 처리 강화
│   ├ msgbox() 디버깅
│   └ PyQt6 import + 앱 실행
│
├── output_detail_tab.py ✅ 부분 완성 (메인 UI, 갑지)
│   ├ class OutputDetailTab:
│   │   ├ __init__: 공종 폴더 경로, 데이터 저장소 초기화
│   │   ├ create_tab(): 메인 UI 생성
│   │   │   ├ 상단 메뉴 바
│   │   │   ├ 좌측: 갑지 테이블 (산출내역서 메인)
│   │   │   └ 우측: 공종 리스트 패널
│   │   ├ record_undo/undo: 작업 취소
│   │   ├ TableEventFilter: Ctrl+N/Y 등 단축키
│   │   └ LightingPowerManager: 전등/전열 매니저
│   │
│   └─ 미완료:
│      ├ 세부산출조서 종료 후 산출내역서 데이터 반영
│      └ 재진입 시 상태 복구
│
├── lighting_power_manager.py ⚠️ 부분 완성 (세부산출조서)
│   ├ class LightingPowerManager:
│   │   ├ 전등/전열 공종 관리
│   │   ├ 세부산출조서 팝업 호출
│   │   └ 공종별 처리 로직
│   │
│   ├ class LightingPowerPopup(QDialog): ✅ UI 틀
│   │   ├ _init_ui(): 2분할 패널 생성
│   │   ├ master_table: 산출목록 (좌측)
│   │   ├ detail_table: 산출일위 (우측)
│   │   │   └ 컬럼: W, CODE, 산출목록, 단위수식, 계
│   │   ├ _load_master_data(): 조명기구 목록 로드
│   │   ├ _load_reference_codes(): 자료사전 CODE 로드
│   │   └ (하단 버튼: "선택 적용", "닫기")
│   │
│   └─ 미완료:
│      ├ TAB 키 이벤트 핸들링
│      ├ 자료사전 팝업(3차 창) 호출
│      ├ W 컬럼 검증 표시
│      ├ 데이터 전송 로직
│      ├ 수동 CODE 매칭
│      ├ 1식 저장
│      └ ESC 키 처리
│
├── core/
│   └── app_style.py ✅ 완성 (폰트 + 스타일)
│
├── utils/
│   ├── column_settings.py ✅ (컬럼 정의)
│   └── grid_clipboard.py ✅ (클립보드)
│
└── data/
    └── 자료사전.db ✅ (존재함, 스키마 상세 분석 필요)
```

---

## 🎯 4. 실행 우선순위 로드맵

### **[PHASE 1] 핵심 3기능 구현 (1주일 예상)**
1. **TAB 키 → 자료사전 팝업 호출** (필수)
   - detail_table에 KeyEventFilter 설치
   - TAB 키 감지 시 팝업 호출
   
2. **자료사전 팝업 UI 구성** (필수)
   - 팝업 창 생성
   - 6개 컬럼 테이블 표시
   - 상단 품목 리스트
   
3. **데이터 전송 규칙** (필수)
   - 자료사전 → 산출일위 매핑
   - 검색 기능 구현

### **[PHASE 2] 검증 + 매칭 (1주일 예상)**
4. **W 컬럼 검증 표시**
   - CODE 매칭 로직
   - 상태 표시 (--/~*/등)
   
5. **수동 CODE 매칭 (===)**
   - active_target 선택
   - === 입력 감지
   - CODE 강제 연결

### **[PHASE 3] 저장 + 조각파일 (1주일 예상)**
6. **1식 저장**
   - 세부산출조서 → 산출내역서 반영
   
7. **조각파일 (.piece) 기능**
   - F9 저장/불러오기

### **[PHASE 4] 선택 기능 (선택사항)**
8. 재진입 상태 복구
9. 추가 검증 및 색상 표시
10. Ctrl+S, Ctrl+Z 등 단축키 확장

---

## ⚙️ 5. 즉시 필요한 작업

### **작업 A: 자료사전.db 스키마 확인**
```python
# 실행할 명령어:
D:/이지맥스/.venv/Scripts/python.exe -c "
import sqlite3
conn = sqlite3.connect(r'D:\이지맥스\data\자료사전.db')
cursor = conn.cursor()

# 테이블 목록
cursor.execute(\"SELECT name FROM sqlite_master WHERE type='table'\")
tables = cursor.fetchall()
print('[테이블 목록]')
for t in tables:
    print(f'  - {t[0]}')

# 자료사전 테이블 스키마
cursor.execute(\"PRAGMA table_info([자료사전])\")
cols = cursor.fetchall()
print('\\n[자료사전 테이블 컬럼]')
for c in cols:
    print(f'  - {c[1]}: {c[2]}')
"
```

### **작업 B: 일위대가 판정 기준 확인**
- 자료사전.db에 일위대가 구분 컬럼이 있나?
- 조명기구타입.db와의 연관성?
- 어떤 값이 일위대가를 나타내나?

### **작업 C: 조각파일 포맷 결정**
- JSON으로 할 것인가?
- CSV로 할 것인가?
- 이진 포맷으로 할 것인가?

---

## 📋 6. 코드 품질 평가

### 현재 강점 ✅
- 경로 설정 명확화
- 예외 처리 강화
- 사칙연산 안전하게 구현
- Undo 스택 활용
- Master-Detail 구조 명확

### 개선 필요 사항 ⚠️
- `LightingPowerPopup` 클래스가 너무 큼 (683줄) → 분리 권장
- DB 스키마 하드코딩 → 설정 파일 외부화
- 자료사전 팝업이 별도 클래스로 분리되지 않음
- 테스트 코드 부재
- 문서 주석 부족

### 권장 리팩토링 ↻
```
lighting_power_manager.py (683줄)
├── LightingPowerManager 클래스 유지
├── LightingPowerPopup 클래스 유지 (메인 팝업)
└── (새로 생성)
    ├── DatabaseReferencePopup 클래스 (자료사전 팝업)
    ├── CodeMatchingHandler 클래스 (CODE 매칭 로직)
    └── DataTransferHandler 클래스 (데이터 전송 로직)
```

---

## 🚀 7. 다음 단계

**즉시 진행**:
1. ✅ 아키텍처 문서 생성 (완료)
2. ⏳ 자료사전.db 스키마 상세 분석
3. ⏳ 일위대가 판정 기준 확정
4. ⏳ TAB 키 이벤트 핸들러 구현
5. ⏳ 자료사전 팝업 UI 구현

**사용자 확인 필요**:
- [ ] 조각파일 (.piece) 포맷 결정
- [ ] 수동 매칭 저장 위치 결정
- [ ] 미매칭(~*) 저장 정책 결정
- [ ] 일위대가 판정 기준 설명
- [ ] 자료사전.db 스키마 상세 설명

---

**리포트 작성자**: GitHub Copilot  
**마지막 수정**: 2026-01-31
