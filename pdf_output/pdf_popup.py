# -*- coding: utf-8 -*-
"""
PDF ì‚°ì¶œ ì‹œìŠ¤í…œ - CAD ìŠ¤íƒ€ì¼ ë©”ì¸ íŒì—…
====================================
ë ˆì´ì•„ì›ƒ (ì‚¬ì´ë“œ íŒ¨ë„ ì—†ìŒ, ì „ì²´ ë„ˆë¹„ ë·°ì–´):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ íŒŒì¼(F) â”‚ í¸ì§‘(E) â”‚ ë³´ê¸°(V) â”‚ ë„êµ¬(T) â”‚ ë„ì›€ë§(H)             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ“‚ì—´ê¸°â”‚â—€ 1/1 â–¶â”‚ğŸ”âˆ’ 100% ğŸ”+ ë§ì¶¤â”‚â”ì„  â–¢ë©´â”‚ğŸ¨â”‚êµµê¸°â”‚ğŸ—‘â”‚ì—°ì¥ ìˆ˜ëŸ‰â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ìœ í˜•:[ë°°ê´€â–¼] ê¹Šì´:[0.80] í­:[0.60] ê·œê²©:[50Aâ–¼] ìœ„ì¹˜:[    ]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚              PDF ë„ë©´ ë·°ì–´ (ì „ì²´ ë„ˆë¹„, ìµœëŒ€ ë†’ì´)              â”‚
â”‚                                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ“‹ì‚°ì¶œëª©ë¡ #â”‚ìœ í˜•â”‚ìœ„ì¹˜â”‚ê·œê²©â”‚ì—°ì¥â”‚ìˆ˜ëŸ‰â”‚ë‹¨ìœ„â”‚ [ì‚­ì œ][ì „ì²´ì‚­ì œ][ì ìš©]â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ íŒŒì¼:(ì—†ìŒ) â”‚ ì¤Œ: 100% â”‚ í˜ì´ì§€: 1/1                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
"""
import os
from PyQt6.QtWidgets import (
    QDialog, QVBoxLayout, QHBoxLayout,
    QMenuBar, QFrame,
    QTableWidget, QTableWidgetItem,
    QPushButton, QComboBox, QLabel, QLineEdit,
    QSpinBox, QDoubleSpinBox,
    QMessageBox, QFileDialog, QColorDialog,
    QAbstractItemView, QWidget,
    QGraphicsTextItem, QSizePolicy,
)
from PyQt6.QtCore import Qt, pyqtSignal, QRectF, QSize
from PyQt6.QtGui import QFont, QColor, QPen, QBrush, QPixmap, QKeySequence, QAction

from .pdf_viewer import PDFGraphicsView
from .pdf_models import OutputItem

# PDF ë Œë”ë§ ì§€ì› í™•ì¸
try:
    from PyQt6.QtPdf import QPdfDocument
    PDF_SUPPORT = True
except ImportError:
    PDF_SUPPORT = False
    print("[WARN] PyQt6.QtPdf ë¯¸ì„¤ì¹˜: pip install PyQt6-Pdf")


# ê³µí†µ ë²„íŠ¼ ìŠ¤íƒ€ì¼
BTN_STYLE = """
    QPushButton {
        background-color: #f5f5f5; border: 1px solid #999;
        border-radius: 2px; padding: 2px 7px;
        font-family: 'ìƒˆêµ´ë¦¼'; font-size: 10pt; min-height: 22px;
    }
    QPushButton:hover { background-color: #ddeeff; border-color: #6699cc; }
    QPushButton:pressed { background-color: #bbddff; }
    QPushButton:checked { background-color: #cce5ff; border-color: #3399ff; font-weight: bold; }
"""

LABEL_STYLE = "font-family: 'ìƒˆêµ´ë¦¼'; font-size: 9pt; color: #555;"


class PDFOutputPopup(QDialog):
    """
    CAD ìŠ¤íƒ€ì¼ PDF ì‚°ì¶œ íŒì—…
    PDF ë„ë©´ì—ì„œ ì‚°ì¶œ í•­ëª©ì„ ì§ì ‘ ì„ íƒí•˜ê³  ìˆ˜ëŸ‰ ì‚°ì •
    """

    closed = pyqtSignal(dict)

    # ì‚°ì¶œ ìœ í˜• ì •ì˜
    OUTPUT_TYPES = {
        "í„°íŒŒê¸°(ì§€ì¤‘)": {"icon": "ğŸ•³ï¸", "unit": "mÂ³", "color": "#8B4513", "default_depth": 0.8},
        "ë°°ê´€":        {"icon": "ğŸ”§", "unit": "m",  "color": "#4682B4", "default_depth": 0.0},
        "TRAY":        {"icon": "ğŸ“", "unit": "m",  "color": "#708090", "default_depth": 0.0},
        "DUCT":        {"icon": "ğŸŒªï¸", "unit": "m",  "color": "#DEB887", "default_depth": 0.0},
        "Raceway":     {"icon": "ğŸ”²", "unit": "m",  "color": "#6B8E23", "default_depth": 0.0},
        "ë§¤ëª°(Concrete)": {"icon": "ğŸ§±", "unit": "mÂ³", "color": "#A9A9A9", "default_depth": 0.1},
        "í˜„ê´€(Exposed)":  {"icon": "ğŸ—ï¸", "unit": "m",  "color": "#B8860B", "default_depth": 0.0},
    }

    def __init__(self, parent=None, eulji_data: dict = None):
        super().__init__(parent)
        self.setWindowTitle("PDF ì‚°ì¶œ ì‹œìŠ¤í…œ")
        self.setMinimumSize(900, 600)
        self.resize(1400, 900)

        # ì „ì²´í™”ë©´/ìµœëŒ€í™” ì§€ì›
        self.setWindowFlags(
            Qt.WindowType.Window
            | Qt.WindowType.WindowMinMaxButtonsHint
            | Qt.WindowType.WindowCloseButtonHint
        )

        # ìƒíƒœ
        self.eulji_data = eulji_data or {}
        self.current_pdf_path = None
        self.pdf_document = None
        self.output_items = []
        self.item_counter = 0
        self.current_color = "#FF0000"

        self._setup_ui()

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• UI êµ¬ì„± â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    def _setup_ui(self):
        """ì „ì²´ UI êµ¬ì„± (ìˆ˜ì§ ë ˆì´ì•„ì›ƒ, ì‚¬ì´ë“œ íŒ¨ë„ ì—†ìŒ)"""
        main = QVBoxLayout(self)
        main.setContentsMargins(0, 0, 0, 0)
        main.setSpacing(0)

        # 1. ë©”ë‰´ ë°” (ê³ ì • ë†’ì´)
        self._create_menu_bar(main)

        # 2. íˆ´ë°” (ê³ ì • ë†’ì´)
        self._create_toolbar(main)

        # 3. ì„¤ì • ë°” - ì‚°ì¶œ ìœ í˜•/ê¹Šì´/í­/ê·œê²©/ìœ„ì¹˜ (í•œ ì¤„)
        self._create_settings_bar(main)

        # 4. PDF ë·°ì–´ + í•˜ë‹¨ ì‚°ì¶œëª©ë¡ (ìˆ˜ì§ ìŠ¤í”Œë¦¬í„°)
        self._create_viewer_and_table(main)

        # 5. ìƒíƒœ ë°” (ê³ ì • ë†’ì´)
        self._create_status_bar(main)

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 1. ë©”ë‰´ ë°” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    def _create_menu_bar(self, layout):
        """ë©”ë‰´ ë°”"""
        mb = QMenuBar(self)
        mb.setFixedHeight(26)
        mb.setStyleSheet("""
            QMenuBar {
                background: #f0f0f0; border-bottom: 1px solid #ccc;
                font-family: 'ìƒˆêµ´ë¦¼'; font-size: 11pt; padding: 1px;
            }
            QMenuBar::item { padding: 3px 10px; background: transparent; }
            QMenuBar::item:selected { background: #e0e0e0; }
            QMenu { font-family: 'ìƒˆêµ´ë¦¼'; font-size: 11pt; }
            QMenu::item { padding: 5px 30px 5px 15px; }
            QMenu::item:selected { background: #0078d7; color: white; }
            QMenu::separator { height: 1px; background: #ccc; margin: 3px 5px; }
        """)

        # â”€ íŒŒì¼ â”€
        fm = mb.addMenu("íŒŒì¼(&F)")
        self._add_action(fm, "ğŸ“‚ PDF ì—´ê¸°", "Ctrl+O", self._open_pdf)
        fm.addSeparator()
        self._add_action(fm, "ğŸ“¤ ì‚°ì¶œ ì ìš©", "Ctrl+S", self._export_output)
        fm.addSeparator()
        self._add_action(fm, "ë‹«ê¸°", "Ctrl+W", self.close)

        # â”€ í¸ì§‘ â”€
        em = mb.addMenu("í¸ì§‘(&E)")
        self._add_action(em, "ğŸ—‘ï¸ ì„ íƒ ì‚­ì œ", "Delete", self._delete_selected)
        self._add_action(em, "ğŸ—‘ï¸ ì „ì²´ ì‚­ì œ", None, self._clear_all)

        # â”€ ë³´ê¸° â”€
        vm = mb.addMenu("ë³´ê¸°(&V)")
        self._add_action(vm, "ğŸ” í™•ëŒ€", "Ctrl++", lambda: self._zoom(1.25))
        self._add_action(vm, "ğŸ” ì¶•ì†Œ", "Ctrl+-", lambda: self._zoom(0.8))
        self._add_action(vm, "ğŸ“ í™”ë©´ ë§ì¶¤", "Ctrl+0", self._fit_view)
        vm.addSeparator()
        self._add_action(vm, "â—€ ì´ì „ í˜ì´ì§€", "PgUp", self._prev_page)
        self._add_action(vm, "â–¶ ë‹¤ìŒ í˜ì´ì§€", "PgDown", self._next_page)
        vm.addSeparator()
        self._add_action(vm, "ğŸ–¥ï¸ ì „ì²´í™”ë©´", "F11", self._toggle_fullscreen)

        # â”€ ë„êµ¬ â”€
        tm = mb.addMenu("ë„êµ¬(&T)")
        self.act_draw_line = QAction("â” ì„  ê·¸ë¦¬ê¸°", self)
        self.act_draw_line.setCheckable(True)
        self.act_draw_line.triggered.connect(self._toggle_line_draw)
        tm.addAction(self.act_draw_line)
        self.act_draw_rect = QAction("â–¢ ë©´ ê·¸ë¦¬ê¸°", self)
        self.act_draw_rect.setCheckable(True)
        self.act_draw_rect.triggered.connect(self._toggle_rect_draw)
        tm.addAction(self.act_draw_rect)
        tm.addSeparator()
        self._add_action(tm, "ğŸ¨ ìƒ‰ìƒ ì„ íƒ", None, self._select_color)
        # ê·¸ë¦¬ê¸° ì§€ìš°ê¸°ëŠ” pdf_view ìƒì„± í›„ ì—°ê²°í•˜ë¯€ë¡œ ë‚˜ì¤‘ì—

        # â”€ ë„ì›€ë§ â”€
        hm = mb.addMenu("ë„ì›€ë§(&H)")
        self._add_action(hm, "â„¹ï¸ ì‚¬ìš©ë²•", None, self._show_help)

        layout.addWidget(mb, 0)

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 2. íˆ´ë°” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    def _create_toolbar(self, layout):
        """íˆ´ë°” (í•œ ì¤„, 32px ë†’ì´)"""
        tb = QFrame()
        tb.setFixedHeight(30)
        tb.setStyleSheet("QFrame { background: #e8e8e8; border-bottom: 1px solid #bbb; }")
        h = QHBoxLayout(tb)
        h.setContentsMargins(4, 1, 4, 1)
        h.setSpacing(2)

        # PDF ì—´ê¸°
        b = self._tb_btn("ğŸ“‚ ì—´ê¸°", "PDF íŒŒì¼ ì—´ê¸° (Ctrl+O)")
        b.clicked.connect(self._open_pdf)
        h.addWidget(b)

        self._sep(h)

        # í˜ì´ì§€ ë„¤ë¹„ê²Œì´ì…˜
        b = self._tb_btn("â—€", "ì´ì „ í˜ì´ì§€")
        b.setFixedWidth(24)
        b.clicked.connect(self._prev_page)
        h.addWidget(b)

        self.page_spin = QSpinBox()
        self.page_spin.setRange(1, 1)
        self.page_spin.setFixedWidth(45)
        self.page_spin.setAlignment(Qt.AlignmentFlag.AlignCenter)
        self.page_spin.setStyleSheet("font-size: 9pt;")
        self.page_spin.valueChanged.connect(self._go_to_page)
        h.addWidget(self.page_spin)

        self.page_label = QLabel("/1")
        self.page_label.setStyleSheet(LABEL_STYLE)
        h.addWidget(self.page_label)

        b = self._tb_btn("â–¶", "ë‹¤ìŒ í˜ì´ì§€")
        b.setFixedWidth(24)
        b.clicked.connect(self._next_page)
        h.addWidget(b)

        self._sep(h)

        # ì¤Œ
        b = self._tb_btn("ğŸ”âˆ’", "ì¶•ì†Œ")
        b.setFixedWidth(32)
        b.clicked.connect(lambda: self._zoom(0.8))
        h.addWidget(b)

        self.zoom_label = QLabel("100%")
        self.zoom_label.setFixedWidth(40)
        self.zoom_label.setAlignment(Qt.AlignmentFlag.AlignCenter)
        self.zoom_label.setStyleSheet(LABEL_STYLE)
        h.addWidget(self.zoom_label)

        b = self._tb_btn("ğŸ”+", "í™•ëŒ€")
        b.setFixedWidth(32)
        b.clicked.connect(lambda: self._zoom(1.25))
        h.addWidget(b)

        b = self._tb_btn("ë§ì¶¤", "í™”ë©´ ë§ì¶¤ (Ctrl+0)")
        b.clicked.connect(self._fit_view)
        h.addWidget(b)

        self._sep(h)

        # ê·¸ë¦¬ê¸°
        self.btn_draw_line = self._tb_btn("â” ì„ ", "ì„  ê·¸ë¦¬ê¸°")
        self.btn_draw_line.setCheckable(True)
        self.btn_draw_line.toggled.connect(self._on_line_toggled)
        h.addWidget(self.btn_draw_line)

        self.btn_draw_rect = self._tb_btn("â–¢ ë©´", "ë©´ ê·¸ë¦¬ê¸°")
        self.btn_draw_rect.setCheckable(True)
        self.btn_draw_rect.toggled.connect(self._on_rect_toggled)
        h.addWidget(self.btn_draw_rect)

        self._sep(h)

        # ìƒ‰ìƒ
        self.color_btn = QPushButton()
        self.color_btn.setFixedSize(20, 20)
        self.color_btn.setStyleSheet(f"background: {self.current_color}; border: 1px solid #666; border-radius: 2px;")
        self.color_btn.setToolTip("ìƒ‰ìƒ ì„ íƒ")
        self.color_btn.clicked.connect(self._select_color)
        h.addWidget(self.color_btn)

        h.addWidget(QLabel("êµµê¸°:"))
        self.line_width_spin = QSpinBox()
        self.line_width_spin.setRange(1, 10)
        self.line_width_spin.setValue(3)
        self.line_width_spin.setSuffix("px")
        self.line_width_spin.setFixedWidth(50)
        self.line_width_spin.setStyleSheet("font-size: 9pt;")
        h.addWidget(self.line_width_spin)

        self._sep(h)

        b = self._tb_btn("ğŸ—‘ï¸ ì§€ìš°ê¸°", "ê·¸ë¦¬ê¸° ëª¨ë‘ ì§€ìš°ê¸°")
        b.clicked.connect(self._clear_drawings)
        h.addWidget(b)

        h.addStretch()

        # í†µê³„ (ìš°ì¸¡)
        self.stat_length = QLabel("ì—°ì¥: 0m")
        self.stat_length.setStyleSheet("font-weight: bold; font-size: 10pt; color: #333; font-family: 'ìƒˆêµ´ë¦¼';")
        h.addWidget(self.stat_length)
        h.addSpacing(8)
        self.stat_qty = QLabel("ìˆ˜ëŸ‰: 0")
        self.stat_qty.setStyleSheet("font-weight: bold; font-size: 10pt; color: #0066cc; font-family: 'ìƒˆêµ´ë¦¼';")
        h.addWidget(self.stat_qty)

        layout.addWidget(tb, 0)

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 3. ì„¤ì • ë°” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    def _create_settings_bar(self, layout):
        """ì‚°ì¶œ ìœ í˜•/ì„¤ì •ì„ í•œ ì¤„ë¡œ ì••ì¶•"""
        bar = QFrame()
        bar.setFixedHeight(30)
        bar.setStyleSheet("""
            QFrame { background: #f5f5f0; border-bottom: 1px solid #ccc; }
            QLabel { font-family: 'ìƒˆêµ´ë¦¼'; font-size: 9pt; color: #444; }
            QComboBox, QDoubleSpinBox, QLineEdit {
                font-family: 'ìƒˆêµ´ë¦¼'; font-size: 9pt; padding: 1px 3px; min-height: 20px;
            }
        """)
        h = QHBoxLayout(bar)
        h.setContentsMargins(6, 2, 6, 2)
        h.setSpacing(4)

        # ì‚°ì¶œ ìœ í˜• (ì½¤ë³´ë°•ìŠ¤ë¡œ ë³€ê²½)
        h.addWidget(QLabel("ìœ í˜•:"))
        self.type_combo = QComboBox()
        self.type_combo.setFixedWidth(130)
        for t, info in self.OUTPUT_TYPES.items():
            self.type_combo.addItem(f"{info['icon']} {t}", t)
        self.type_combo.setCurrentIndex(1)  # ê¸°ë³¸: ë°°ê´€
        h.addWidget(self.type_combo)

        self._sep(h)

        # ê¹Šì´
        h.addWidget(QLabel("ê¹Šì´:"))
        self.depth_spin = QDoubleSpinBox()
        self.depth_spin.setRange(0, 10)
        self.depth_spin.setDecimals(2)
        self.depth_spin.setValue(0.8)
        self.depth_spin.setSuffix("m")
        self.depth_spin.setFixedWidth(65)
        h.addWidget(self.depth_spin)

        # í­
        h.addWidget(QLabel("í­:"))
        self.width_spin = QDoubleSpinBox()
        self.width_spin.setRange(0, 10)
        self.width_spin.setDecimals(2)
        self.width_spin.setValue(0.6)
        self.width_spin.setSuffix("m")
        self.width_spin.setFixedWidth(65)
        h.addWidget(self.width_spin)

        self._sep(h)

        # ê·œê²©
        h.addWidget(QLabel("ê·œê²©:"))
        self.spec_combo = QComboBox()
        self.spec_combo.setEditable(True)
        self.spec_combo.setFixedWidth(80)
        self.spec_combo.addItems([
            "50A", "65A", "80A", "100A", "125A", "150A",
            "100mm", "150mm", "200mm", "300mm",
            "50x50", "100x50", "100x100",
        ])
        h.addWidget(self.spec_combo)

        self._sep(h)

        # ìœ„ì¹˜
        h.addWidget(QLabel("ìœ„ì¹˜:"))
        self.location_edit = QLineEdit()
        self.location_edit.setPlaceholderText("ì˜ˆ: 1ì¸µ ì „ë“±ë™")
        self.location_edit.setFixedWidth(130)
        h.addWidget(self.location_edit)

        h.addStretch()

        layout.addWidget(bar, 0)

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 4. PDF ë·°ì–´ + ì‚°ì¶œëª©ë¡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    def _create_viewer_and_table(self, layout):
        """PDF ë·°ì–´(ëŒ€) + í•˜ë‹¨ ì‚°ì¶œëª©ë¡(ì»´íŒ©íŠ¸ ê³ ì •)"""
        # â”€â”€ PDF ë·°ì–´ (ì „ì²´ ë„ˆë¹„, stretch=1 â†’ ìµœëŒ€ ê³µê°„ ì°¨ì§€) â”€â”€
        self.pdf_view = PDFGraphicsView()
        self.pdf_view.zoom_changed.connect(
            lambda pct: self.zoom_label.setText(f"{pct}%")
        )
        # ë§ˆìš°ìŠ¤ íœ  í˜ì´ì§€ ë„˜ê¹€ ì—°ê²°
        self.pdf_view.page_change_requested.connect(self._on_wheel_page_change)
        self.pdf_view.setSizePolicy(
            QSizePolicy.Policy.Expanding, QSizePolicy.Policy.Expanding
        )
        layout.addWidget(self.pdf_view, 1)  # stretch=1 â†’ ë‚˜ë¨¸ì§€ ê³µê°„ ì „ë¶€

        # output_tableì€ ë‚´ë¶€ ë°ì´í„° ìš©ë„ë¡œë§Œ ìœ ì§€ (í™”ë©´ì— í‘œì‹œí•˜ì§€ ì•ŠìŒ)
        self.output_table = None

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 5. ìƒíƒœ ë°” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    def _create_status_bar(self, layout):
        """í•˜ë‹¨ ìƒíƒœ ë°”"""
        bar = QFrame()
        bar.setFixedHeight(22)
        bar.setStyleSheet("""
            QFrame { background: #e8e8e8; border-top: 1px solid #bbb; }
            QLabel { font-family: 'ìƒˆêµ´ë¦¼'; font-size: 9pt; color: #444; padding: 0 6px; }
        """)
        h = QHBoxLayout(bar)
        h.setContentsMargins(5, 0, 5, 0)
        h.setSpacing(0)

        self.st_file = QLabel("íŒŒì¼: (ì—†ìŒ)")
        h.addWidget(self.st_file)
        h.addWidget(QLabel("|"))

        self.st_count = QLabel("í•­ëª©: 0ê°œ")
        h.addWidget(self.st_count)
        h.addWidget(QLabel("|"))

        self.st_zoom = QLabel("ì¤Œ: 100%")
        h.addWidget(self.st_zoom)
        self.pdf_view.zoom_changed.connect(lambda p: self.st_zoom.setText(f"ì¤Œ: {p}%"))
        h.addWidget(QLabel("|"))

        self.st_page = QLabel("í˜ì´ì§€: 1/1")
        h.addWidget(self.st_page)

        h.addStretch()
        layout.addWidget(bar, 0)

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• PDF ë¡œë“œ/ë Œë”ë§ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    def _open_pdf(self):
        """PDF íŒŒì¼ ì—´ê¸°"""
        fp, _ = QFileDialog.getOpenFileName(
            self, "PDF ë„ë©´ ì—´ê¸°", "", "PDF Files (*.pdf);;All Files (*.*)"
        )
        if fp:
            self._load_pdf(fp)

    def _load_pdf(self, fp):
        """PDF ë¡œë“œ"""
        if not PDF_SUPPORT:
            QMessageBox.warning(self, "PDF ë¯¸ì§€ì›",
                "PyQt6.QtPdfê°€ ì„¤ì¹˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\npip install PyQt6-Pdf")
            return

        try:
            self.current_pdf_path = fp
            self.pdf_document = QPdfDocument(self)
            self.pdf_document.load(fp)

            pc = self.pdf_document.pageCount()
            if pc <= 0:
                raise RuntimeError(f"PDF í˜ì´ì§€ ìˆ˜: {pc}")

            self.page_spin.setRange(1, pc)
            self.page_spin.setValue(1)
            self.page_label.setText(f"/{pc}")

            fn = os.path.basename(fp)
            self.st_file.setText(f"íŒŒì¼: {fn}")
            self.st_page.setText(f"í˜ì´ì§€: 1/{pc}")

            self._render_page(0)
            print(f"[OK] PDF ë¡œë“œ: {fp} ({pc}p)")

        except Exception as e:
            import traceback; traceback.print_exc()
            QMessageBox.critical(self, "PDF ì˜¤ë¥˜", f"PDFë¥¼ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n\n{e}")

    def _render_page(self, idx):
        """í˜ì´ì§€ ë Œë”ë§"""
        if not self.pdf_document:
            return
        if idx < 0 or idx >= self.pdf_document.pageCount():
            return

        try:
            ps = self.pdf_document.pagePointSize(idx)
            dpi = 150.0
            s = dpi / 72.0
            w, h = int(ps.width() * s), int(ps.height() * s)
            if w <= 0 or h <= 0:
                raise RuntimeError(f"ì˜ëª»ëœ í¬ê¸°: {w}x{h}")

            image = self.pdf_document.render(idx, QSize(w, h))
            if image.isNull():
                raise RuntimeError("ë Œë”ë§ ê²°ê³¼ ì—†ìŒ")

            self.pdf_view.scene.clear()
            self.pdf_view.drawing_items.clear()
            pixmap = QPixmap.fromImage(image)
            self.pdf_view.scene.addPixmap(pixmap)
            self.pdf_view.scene.setSceneRect(QRectF(0, 0, pixmap.width(), pixmap.height()))
            self.pdf_view.fit_to_view()

            pc = self.pdf_document.pageCount()
            self.st_page.setText(f"í˜ì´ì§€: {idx+1}/{pc}")

        except Exception as e:
            import traceback; traceback.print_exc()
            self.pdf_view.scene.clear()
            self.pdf_view.scene.addRect(
                QRectF(0, 0, 800, 1100), QPen(Qt.GlobalColor.black), QBrush(Qt.GlobalColor.white))
            t = QGraphicsTextItem(f"PDF ë Œë”ë§ ì‹¤íŒ¨:\n{e}")
            t.setPos(50, 50); t.setDefaultTextColor(QColor("#cc0000"))
            self.pdf_view.scene.addItem(t)

    def _go_to_page(self, n):
        if self.pdf_document:
            self._render_page(n - 1)

    def _prev_page(self):
        v = self.page_spin.value()
        if v > 1:
            self.page_spin.setValue(v - 1)

    def _next_page(self):
        v = self.page_spin.value()
        if v < self.page_spin.maximum():
            self.page_spin.setValue(v + 1)

    def _on_wheel_page_change(self, delta):
        """ë§ˆìš°ìŠ¤ íœ  í˜ì´ì§€ ë„˜ê¹€ (-1=ì´ì „, +1=ë‹¤ìŒ)"""
        if delta < 0:
            self._next_page()
        elif delta > 0:
            self._prev_page()

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ì¤Œ / ì „ì²´í™”ë©´ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    def _zoom(self, factor):
        self.pdf_view.scale(factor, factor)
        self.pdf_view._zoom_factor *= factor
        p = int(self.pdf_view._zoom_factor * 100)
        self.zoom_label.setText(f"{p}%")
        self.st_zoom.setText(f"ì¤Œ: {p}%")

    def _fit_view(self):
        self.pdf_view.fit_to_view()

    def _toggle_fullscreen(self):
        if self.isFullScreen():
            self.showNormal()
        else:
            self.showFullScreen()

    def keyPressEvent(self, event):
        if event.key() == Qt.Key.Key_F11:
            self._toggle_fullscreen(); return
        if event.key() == Qt.Key.Key_Escape and self.isFullScreen():
            self.showNormal(); return
        super().keyPressEvent(event)

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ê·¸ë¦¬ê¸° ë„êµ¬ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    def _toggle_line_draw(self, checked):
        if checked:
            self.act_draw_rect.setChecked(False)
            self.btn_draw_rect.setChecked(False)
            self.pdf_view.set_drawing_mode("line", self.current_color)
        elif not self.act_draw_rect.isChecked():
            self.pdf_view.set_drawing_mode(None)

    def _toggle_rect_draw(self, checked):
        if checked:
            self.act_draw_line.setChecked(False)
            self.btn_draw_line.setChecked(False)
            self.pdf_view.set_drawing_mode("rect", self.current_color)
        elif not self.act_draw_line.isChecked():
            self.pdf_view.set_drawing_mode(None)

    def _on_line_toggled(self, checked):
        self.act_draw_line.setChecked(checked)
        self._toggle_line_draw(checked)

    def _on_rect_toggled(self, checked):
        self.act_draw_rect.setChecked(checked)
        self._toggle_rect_draw(checked)

    def _select_color(self):
        color = QColorDialog.getColor(QColor(self.current_color), self, "ìƒ‰ìƒ ì„ íƒ")
        if color.isValid():
            self.current_color = color.name()
            self.color_btn.setStyleSheet(
                f"background: {self.current_color}; border: 1px solid #666; border-radius: 2px;")
            self.pdf_view.current_pen = QPen(color, self.line_width_spin.value())
            self.pdf_view.current_pen.setCosmetic(True)

    def _clear_drawings(self):
        self.pdf_view.clear_drawings()

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ì‚°ì¶œ í•­ëª© ê´€ë¦¬ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    def _update_table(self):
        """ì‚°ì¶œ í†µê³„ ê°±ì‹  (í…Œì´ë¸” ì œê±°ë¨, ìƒíƒœë°”/íˆ´ë°”ë§Œ ì—…ë°ì´íŠ¸)"""
        tl = sum(it.length for it in self.output_items)
        tq = sum(it.quantity for it in self.output_items)
        self.st_count.setText(f"í•­ëª©: {len(self.output_items)}ê°œ")
        self.stat_length.setText(f"ì—°ì¥: {tl:.2f}m")
        self.stat_qty.setText(f"ìˆ˜ëŸ‰: {tq:.3f}")

    def _delete_selected(self):
        if self.output_items:
            self.output_items.pop()
            self._update_table()

    def _clear_all(self):
        if QMessageBox.question(
            self, "í™•ì¸", "ëª¨ë“  ì‚°ì¶œ í•­ëª©ì„ ì‚­ì œ?",
            QMessageBox.StandardButton.Yes | QMessageBox.StandardButton.No,
        ) == QMessageBox.StandardButton.Yes:
            self.output_items.clear()
            self.item_counter = 0
            self.pdf_view.clear_drawings()
            self._update_table()

    def _export_output(self):
        if not self.output_items:
            QMessageBox.warning(self, "ê²½ê³ ", "ì‚°ì¶œí•  í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.")
            return

        result = {
            "items": [
                {k: getattr(it, k) for k in
                 ("id","output_type","location","specification",
                  "length","width","depth","area","quantity","unit","notes")}
                for it in self.output_items
            ],
            "total_length": sum(it.length for it in self.output_items),
            "total_quantity": sum(it.quantity for it in self.output_items),
        }
        self.closed.emit(result)
        QMessageBox.information(
            self, "ì™„ë£Œ",
            f"ì‚°ì¶œ ì ìš© ì™„ë£Œ\ní•­ëª©: {len(self.output_items)}ê°œ\n"
            f"ì—°ì¥: {result['total_length']:.2f}m\nìˆ˜ëŸ‰: {result['total_quantity']:.3f}")
        self.accept()

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ë„ì›€ë§ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    def _show_help(self):
        QMessageBox.information(
            self, "PDF ì‚°ì¶œ ì‚¬ìš©ë²•",
            "â–  PDF ì—´ê¸°: íŒŒì¼>ì—´ê¸° ë˜ëŠ” Ctrl+O\n"
            "â–  í˜ì´ì§€: â—€â–¶ ë˜ëŠ” PgUp/PgDown\n"
            "â–  ì¤Œ: ë§ˆìš°ìŠ¤ íœ  ë˜ëŠ” Ctrl+Â±, ë§ì¶¤=Ctrl+0\n"
            "â–  ì „ì²´í™”ë©´: F11, í•´ì œ=ESC\n"
            "â–  ê·¸ë¦¬ê¸°: ì„ (â”)/ë©´(â–¢) ë„êµ¬ ì„ íƒ í›„ ë„ë©´ì— ë“œë˜ê·¸\n"
            "â–  ì‚°ì¶œ: ìœ í˜• ì„ íƒâ†’ë„ë©´ ê·¸ë¦¬ê¸°â†’ì‚°ì¶œ ì ìš©")

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ìœ í‹¸ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    def _tb_btn(self, text, tip=None):
        b = QPushButton(text)
        b.setStyleSheet(BTN_STYLE)
        if tip:
            b.setToolTip(tip)
        return b

    @staticmethod
    def _sep(layout):
        s = QFrame()
        s.setFrameShape(QFrame.Shape.VLine)
        s.setFixedHeight(20)
        s.setStyleSheet("color: #bbb;")
        layout.addWidget(s)

    def _add_action(self, menu, text, shortcut, callback):
        act = QAction(text, self)
        if shortcut:
            act.setShortcut(QKeySequence(shortcut))
        act.triggered.connect(callback)
        menu.addAction(act)
        return act
